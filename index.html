<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>شبابيك للستائر - Shababek Curtains</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/3y1ZNCk0/1.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" preload>
    
    <!-- Preload for critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { 
            --gold: #d9b382; 
            --brown: #3d2e24; 
            --bg: #f9f6f2; 
            --white: #ffffff; 
            --whatsapp: #25D366; 
            --red: #ff4d4d; 
            --teal: #2A9D8F;
            --blue: #3498db;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html { -webkit-text-size-adjust: 100%; }
        
        body { 
            background: var(--white); 
            color: var(--brown); 
            overflow-x: hidden; 
            scroll-behavior: smooth; 
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
        }

        button, a, .cat-card-new, .cart-icon, .search-box {
            touch-action: manipulation;
        }

        .top-banner { background: var(--brown); color: white; padding: 10px 5%; text-align: center; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .wa-link { color: var(--whatsapp); text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        header { 
            background: var(--white); 
            padding: 10px 5%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        
        /* اسم المتجر المحسن */
        .store-brand {
            flex: 1;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .store-name-ar {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--brown);
            letter-spacing: 0.5px;
        }
        
        .store-name-en {
            font-size: 0.9rem;
            color: var(--gold);
            font-weight: 600;
            margin-top: 2px;
            text-transform: uppercase;
        }
        
        .logo-center { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            cursor: pointer; 
        }
        
        .logo-img { 
            height: 90px; 
            transition: 0.3s; 
        }
        
        .header-left { 
            flex: 1; 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            gap: 15px; 
        }
        
        /* أيقونة السلة المحسنة */
        .cart-icon { 
            position: relative; 
            cursor: pointer; 
            width: 55px;
            height: 55px;
            background: linear-gradient(145deg, var(--gold), #c9a067);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 20px rgba(217, 179, 130, 0.3);
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .cart-icon:hover {
            transform: scale(1.1) rotate(-5deg);
            background: linear-gradient(145deg, #c9a067, var(--gold));
            box-shadow: 0 10px 30px rgba(217, 179, 130, 0.5);
        }
        
        .cart-icon:active {
            transform: scale(0.95);
        }
        
        .cart-icon i {
            font-size: 2rem;
            color: white;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2));
            animation: bounce 2s infinite ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(5deg); }
        }
        
        .cart-count { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: var(--red); 
            color: white; 
            font-size: 0.9rem; 
            font-weight: 900; 
            min-width: 28px;
            height: 28px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: pulse 1.5s infinite;
            padding: 0 5px;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
        }
        
        /* تحسين البحث */
        .search-container {
            position: relative;
        }
        
        .search-box { 
            position: relative; 
            width: 40px; 
            height: 40px; 
            transition: 0.4s; 
            overflow: hidden; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
        }
        
        .search-box:hover, .search-box:focus-within { 
            width: 250px; 
            border-color: var(--gold); 
        }
        
        .search-box input { 
            border: none; 
            outline: none; 
            background: transparent; 
            padding: 10px; 
            width: 210px; 
            font-size: 0.9rem; 
        }
        
        .search-box i { 
            padding: 10px; 
            color: var(--brown); 
            cursor: pointer; 
        }
        
        #searchSuggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        #searchSuggestions div {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            transition: 0.3s;
            border-bottom: 1px solid #eee;
        }
        
        #searchSuggestions div:hover {
            background: var(--bg);
        }
        
        #searchSuggestions img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        #searchSuggestions span {
            flex: 1;
            font-weight: 600;
        }
        
        #searchSuggestions small {
            color: var(--gold);
            font-size: 0.8rem;
        }

        .nav-bar { background: #fcfcfc; border-bottom: 1px solid #eee; padding: 12px 0; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .nav-menu { display: inline-flex; gap: 25px; list-style: none; padding: 0 20px; }
        .nav-menu a { text-decoration: none; color: var(--brown); font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .nav-menu a:hover { color: var(--gold); }

        .page { display: none; width: 100%; animation: fadeIn 0.4s ease; }
        .active { display: block !important; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cat-card-new {
            animation: fadeInUp 0.5s ease;
            animation-fill-mode: both;
        }
        
        .cat-card-new:nth-child(1) { animation-delay: 0.1s; }
        .cat-card-new:nth-child(2) { animation-delay: 0.15s; }
        .cat-card-new:nth-child(3) { animation-delay: 0.2s; }
        .cat-card-new:nth-child(4) { animation-delay: 0.25s; }
        .cat-card-new:nth-child(5) { animation-delay: 0.3s; }
        .cat-card-new:nth-child(6) { animation-delay: 0.35s; }
        .cat-card-new:nth-child(7) { animation-delay: 0.4s; }
        .cat-card-new:nth-child(8) { animation-delay: 0.45s; }
        .cat-card-new:nth-child(9) { animation-delay: 0.5s; }
        .cat-card-new:nth-child(10) { animation-delay: 0.55s; }

        #cartOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .cart-modal { background: var(--white); width: 90%; max-width: 500px; border-radius: 30px; padding: 35px; position: relative; max-height: 90vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; }

        /* نافذة التعديل المنبثقة */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .edit-modal.active {
            display: flex;
        }
        
        .edit-modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 25px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gold);
        }
        
        .edit-modal-header h3 {
            font-weight: 900;
            color: var(--brown);
            font-size: 1.4rem;
        }
        
        .edit-modal-close {
            background: var(--red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.3s;
        }
        
        .edit-modal-close:hover {
            transform: rotate(90deg);
            background: #e74c3c;
        }
        
        .edit-form-group {
            margin-bottom: 20px;
        }
        
        .edit-form-group label {
            font-weight: 700;
            display: block;
            margin-bottom: 8px;
            color: var(--brown);
            font-size: 0.95rem;
        }
        
        .edit-form-group input,
        .edit-form-group select,
        .edit-form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-family: 'Cairo';
            font-size: 0.95rem;
            transition: 0.3s;
        }
        
        .edit-form-group input:focus,
        .edit-form-group select:focus {
            border-color: var(--gold);
            outline: none;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--gold);
        }
        
        .edit-save-btn {
            background: var(--teal);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: 900;
            width: 100%;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1.1rem;
            transition: 0.3s;
        }
        
        .edit-save-btn:hover {
            background: #238b7c;
            transform: translateY(-2px);
        }

        /* ===== قسم الهيرو ===== */
        .hero {
            height: 70vh;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .hero-video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .hero-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        .hero-video::-webkit-media-controls {
            display: none !important;
        }

        .hero-video::-webkit-media-controls-start-playback-button {
            display: none !important;
        }

        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 20px;
        }

        .hero h1 { 
            font-size: clamp(1.8rem, 5vw, 3.5rem); 
            font-weight: 900; 
            margin-bottom: 25px; 
            text-shadow: 0 2px 15px rgba(0,0,0,0.5);
            animation: fadeInUp 1s ease;
        }

        .hero-btns { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            width: 100%; 
            max-width: 320px; 
            margin-bottom: 30px; 
        }

        .btn-gold { 
            background: var(--gold); 
            color: white; 
            border: none; 
            padding: 16px 35px; 
            border-radius: 12px; 
            font-weight: 900; 
            cursor: pointer; 
            font-size: 1.1rem; 
            transition: 0.3s; 
        }

        .btn-gold:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn-trans { 
            background: transparent; 
            color: white; 
            border: 2px solid white; 
            padding: 16px 35px; 
            border-radius: 12px; 
            font-weight: 900; 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            transition: 0.3s; 
            backdrop-filter: blur(5px);
        }

        .btn-trans:hover {
            background: var(--gold);
            border-color: var(--gold);
            transform: translateY(-3px);
        }

        .social-hero { 
            display: flex; 
            gap: 20px; 
            animation: fadeInUp 1s ease 0.3s both;
        }

        .social-hero a { 
            color: var(--white); 
            font-size: 1.8rem; 
            transition: 0.4s; 
        }

        .social-hero a:hover { 
            color: var(--gold); 
            transform: translateY(-8px) scale(1.2); 
        }

        .features-section { background: var(--bg); padding: 50px 5%; text-align: center; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; max-width: 1200px; margin: auto; }
        .f-card { background: white; padding: 25px 15px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); transition: 0.3s; }
        .f-card:hover { transform: translateY(-5px); border: 1px solid var(--gold); }

        .stat-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .stat-card { background: #f4f1ed; padding: 25px; border-radius: 20px; text-align: center; }
        .stat-num { font-size: 2.2rem; font-weight: 900; color: var(--gold); display: block; }

        .footer-cta { background: var(--brown); color: white; padding: 40px 5%; text-align: center; border-radius: 40px 40px 0 0; }
        .footer-cta h2 { font-size: 1.6rem; font-weight: 900; margin-bottom: 10px; }
        .btn-footer-wa { background: transparent; border: 1px solid rgba(255,255,255,0.4); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; margin: 5px; font-weight: 600; font-size: 0.9rem; }
        .btn-footer-prod { background: var(--gold); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; margin: 5px; font-weight: 600; font-size: 0.9rem; }

        footer { background: var(--brown); color: rgba(255,255,255,0.6); padding: 20px 5%; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
        
        /* تنسيق أقسام المنتجات */
        #categoriesList {
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important; 
            gap: 15px;
            padding: 20px 5%;
        }

        .cat-card-new {
            position: relative;
            height: 350px;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        
        .cat-card-new:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .cat-card-new img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }
        
        .cat-card-new:hover img {
            transform: scale(1.1);
        }
        
        .cat-card-new > div:last-child {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gold);
            color: white;
            padding: 10px 25px;
            border-radius: 12px;
            font-weight: 900;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .store-name-ar {
                font-size: 1.4rem;
            }
            
            .store-name-en {
                font-size: 0.8rem;
            }
            
            .logo-img { 
                height: 70px; 
            }
            
            #categoriesList {
                display: flex !important;
                grid-template-columns: none !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory;
                gap: 15px;
                padding: 20px;
                -webkit-overflow-scrolling: touch;
            }
            
            #categoriesList .cat-card-new {
                flex: 0 0 250px !important;
                height: 300px;
                scroll-snap-align: start;
            }
        }

        /* تنسيق شبكة المنتجات */
        #catGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 25px;
            padding: 20px 5%;
        }
        
        /* تنسيق طرق الدفع */
        #paymentList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .payment-card {
            position: relative;
            height: 400px;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
            background: white;
            transition: 0.4s;
        }
        
        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
        }
        
        .payment-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 30px;
            display: block;
        }
        
        .payment-card .payment-overlay {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: var(--gold);
            color: white;
            padding: 8px 5px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            font-weight: 900;
            font-size: 1rem;
        }
        
        @media (max-width: 768px) {
            #paymentList {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            .payment-card {
                height: 320px;
            }
        }

        /* مؤشر التحميل */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== مستعرض المنتجات بنظام Alibaba ===== */
        .alibaba-viewer-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .alibaba-viewer-container.active {
            display: flex;
            opacity: 1;
        }
        
        .alibaba-viewer-content {
            width: 100vw;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .alibaba-viewer-header {
            background: var(--brown);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--gold);
            height: 60px;
            flex-shrink: 0;
        }
        
        .alibaba-viewer-header h2 {
            font-size: 1.2rem;
            font-weight: 900;
            margin: 0;
        }
        
        .alibaba-viewer-header .product-code {
            color: var(--gold);
            font-size: 0.8rem;
        }
        
        .alibaba-viewer-close {
            background: var(--gold);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .alibaba-viewer-close:hover {
            transform: rotate(90deg);
            background: var(--brown);
        }
        
        .alibaba-viewer-body {
            display: flex;
            flex: 1;
            min-height: 0;
            height: calc(100vh - 60px);
            overflow: hidden;
            background: #f8f8f8;
        }
        
        .alibaba-viewer-media {
            flex: 1.5;
            padding: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .alibaba-main-image-container {
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid #eee;
            position: relative;
            height: calc(100% - 100px);
            min-height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .alibaba-main-image-container iframe,
        .alibaba-main-image-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        .alibaba-main-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        .alibaba-thumbnail-gallery {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: thin;
            height: 80px;
            flex-shrink: 0;
        }
        
        .alibaba-thumbnail {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.3s;
            flex-shrink: 0;
            background: #f0f0f0;
        }
        
        .alibaba-thumbnail:hover {
            transform: translateY(-3px);
        }
        
        .alibaba-thumbnail.active {
            border-color: var(--gold);
            box-shadow: 0 5px 15px rgba(217, 179, 130, 0.3);
        }
        
        .alibaba-thumbnail img,
        .alibaba-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .alibaba-thumbnail.video-thumb {
            position: relative;
        }
        
        .alibaba-thumbnail.video-thumb::after {
            content: '▶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.5);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .alibaba-slide-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gold);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: 0.3s;
            opacity: 0.8;
        }
        
        .alibaba-slide-nav:hover {
            opacity: 1;
            background: var(--brown);
            transform: translateY(-50%) scale(1.1);
        }
        
        .alibaba-slide-nav.prev {
            left: 10px;
        }
        
        .alibaba-slide-nav.next {
            right: 10px;
        }
        
        .alibaba-viewer-info {
            flex: 1;
            padding: 20px;
            background: white;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow-y: auto;
        }
        
        .alibaba-product-title {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--brown);
            line-height: 1.2;
        }
        
        .alibaba-product-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .alibaba-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 0.85rem;
        }
        
        .alibaba-meta-item i {
            color: var(--gold);
        }
        
        .alibaba-price-section {
            background: #faf5f0;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #f0e0d0;
        }
        
        .alibaba-price-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .alibaba-price {
            font-size: 2rem;
            font-weight: 900;
            color: var(--gold);
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        
        .alibaba-price-unit {
            font-size: 0.9rem;
            color: #999;
            font-weight: normal;
        }
        
        .alibaba-meters-section {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .alibaba-meters-label {
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--brown);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }
        
        .alibaba-meters-label i {
            color: var(--gold);
            font-size: 1.1rem;
        }
        
        .alibaba-meters-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 15px 0;
        }
        
        .alibaba-meters-input {
            flex: 1;
            padding: 18px 20px;
            border: 3px solid var(--gold);
            border-radius: 15px;
            font-size: 1.4rem;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            transition: 0.3s;
            text-align: center;
            background: #fff9f0;
            color: var(--brown);
            box-shadow: 0 5px 15px rgba(217, 179, 130, 0.2);
        }
        
        .alibaba-meters-input:focus {
            border-color: var(--brown);
            outline: none;
            box-shadow: 0 0 0 4px rgba(217, 179, 130, 0.3);
            transform: scale(1.02);
        }
        
        .alibaba-meters-unit {
            font-size: 1.3rem;
            color: var(--gold);
            font-weight: 900;
            background: white;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid var(--gold);
        }
        
        .alibaba-total-price {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #faf5f0;
            padding: 15px 20px;
            border-radius: 12px;
        }
        
        .alibaba-total-label {
            font-weight: 900;
            color: var(--brown);
            font-size: 1.2rem;
        }
        
        .alibaba-total-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .alibaba-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .alibaba-add-to-cart-btn {
            background: var(--gold);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .alibaba-add-to-cart-btn:hover {
            background: var(--brown);
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .alibaba-checkout-btn {
            background: white;
            color: var(--brown);
            border: 3px solid var(--gold);
            padding: 18px;
            border-radius: 15px;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .alibaba-checkout-btn:hover {
            background: var(--gold);
            color: white;
            transform: translateY(-3px);
        }
        
        #hIn {
            padding: 18px 20px !important;
            font-size: 1.4rem !important;
            border: 3px solid var(--gold) !important;
            border-radius: 15px !important;
            text-align: center !important;
            background: #fff9f0 !important;
            margin: 20px 0 !important;
        }
        
        @media (max-width: 768px) {
            .alibaba-viewer-body {
                flex-direction: column;
            }
            
            .alibaba-main-image-container {
                height: 300px;
            }
            
            .alibaba-product-title {
                font-size: 1.2rem;
            }
            
            .alibaba-viewer-header h2 {
                font-size: 1rem;
            }
            
            .alibaba-slide-nav {
                width: 35px;
                height: 35px;
            }
            
            .alibaba-thumbnail {
                width: 60px;
                height: 60px;
            }
            
            .alibaba-meters-input {
                padding: 15px !important;
                font-size: 1.2rem !important;
            }
            
            .alibaba-total-value {
                font-size: 1.5rem;
            }
        }

        /* تحسينات لإضافة الفيديو */
        .video-upload-container {
            margin: 15px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
        }
        
        .video-preview {
            width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 10px;
        }

        /* ===== صفحة تعلم الطباعة المخفية ===== */
        .key {
            background: #444;
            color: white;
            padding: 15px 5px;
            text-align: center;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            box-shadow: 0 4px 0 #222;
            transition: 0.1s;
            cursor: pointer;
        }
        
        .key.active {
            background: var(--gold);
            transform: translateY(4px);
            box-shadow: 0 0 0 #222;
        }
        
        .key.space {
            background: #555;
            padding: 15px;
            grid-column: span 5;
        }
        
        .key.space.active {
            background: var(--gold);
        }
        
        .level-btn {
            transition: 0.3s;
        }
        
        .level-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .level-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px white, 0 0 0 6px var(--gold);
        }
        
        #typingArea {
            transition: 0.3s;
            width: 100%;
            padding: 20px;
            font-size: 1.3rem;
            direction: ltr;
            text-align: left;
            font-family: monospace;
            border: 3px solid #eee;
            border-radius: 12px;
            resize: none;
        }
        
        #typingArea:focus {
            border-color: var(--gold) !important;
            outline: none;
            box-shadow: 0 0 0 4px rgba(217, 179, 130, 0.3);
        }
        
        .correct-char {
            color: var(--teal);
            font-weight: bold;
        }
        
        .wrong-char {
            color: var(--red);
            text-decoration: underline wavy var(--red);
        }
        
        .target-char {
            transition: 0.2s;
        }
        
        .keyboard-container {
            margin-top: 30px;
            background: #333;
            padding: 20px;
            border-radius: 20px;
            direction: ltr;
        }
        
        .keyboard-row {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .keyboard-row.space-row {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
        }
    </style>
</head>
<body>

    <div class="top-banner">
        <span>شبابيك للستائر - ظل وذوق</span>
        <a href="https://wa.me/9647883002797" class="wa-link"><i class="fab fa-whatsapp"></i> تواصل عبر الواتساب</a>
    </div>

    <header>
        <!-- اسم المتجر المحسن -->
        <div class="store-brand">
            <span class="store-name-ar">شبابيك للستائر</span>
            <span class="store-name-en">Shababek Curtains</span>
        </div>
        
        <div class="logo-center" onclick="handleLogoClick()">
            <img src="https://i.ibb.co/3y1ZNCk0/1.png" class="logo-img">
        </div>
        
        <div class="header-left">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search" onclick="handleSmartSearch()"></i>
                    <input type="text" id="searchInput" placeholder="ابحث عن موديل.." onkeyup="debounce(handleSmartSearch, 300)()">
                </div>
                <div id="searchSuggestions"></div>
            </div>
            
            <!-- أيقونة السلة المحسنة -->
            <div class="cart-icon" onclick="toggleCartModal()">
                <i class="fas fa-shopping-basket"></i>
                <span id="globalCartCount" class="cart-count">0</span>
            </div>
        </div>
    </header>
    
    <div id="searchRes"></div>

    <div class="nav-bar">
        <ul class="nav-menu">
            <li><a onclick="showPage('homePage')">الرئيسية</a></li>
            <li><a onclick="showPage('homePage'); setTimeout(() => { document.getElementById('categories').scrollIntoView({behavior: 'smooth'}); }, 100);">المنتجات</a></li>
            <li><a href="ai.html">منتدى شبابيك</a></li>
            <li><a onclick="showPage('paymentPage')">طرق الدفع</a></li>
            <li><a onclick="showPage('aboutPage')">من نحن</a></li>
            <li><a onclick="showPage('contactPage')">تواصل معنا</a></li>
        </ul>
    </div>

    <div id="cartOverlay" onclick="if(event.target===this) toggleCartModal()">
        <div class="cart-modal">
            <h2 style="margin-bottom:20px; border-bottom:2px solid var(--gold); padding-bottom:10px; font-weight:900;">سلة المشتريات</h2>
            <div id="cartItemsList"></div>
            
            <div id="checkoutFields" style="margin-top:20px; border-top:2px solid var(--gold); padding-top:15px;">
                <label style="font-weight:bold; font-size:0.9rem;">المحافظة:</label>
                <select id="userCity">
                    <option value="بغداد">بغداد</option><option value="البصرة">البصرة</option><option value="نينوى">نينوى</option><option value="أربيل">أربيل</option><option value="النجف">النجف</option><option value="كربلاء">كربلاء</option><option value="بابل">بابل</option><option value="الأنبار">الأنبار</option><option value="ذي قار">ذي قار</option><option value="ديالى">ديالى</option><option value="ميسان">ميسان</option><option value="واسط">واسط</option><option value="المثنى">المثنى</option><option value="كركوك">كركوك</option><option value="صلاح الدين">صلاح الدين</option><option value="دهوك">دهوك</option><option value="السليمانية">السليمانية</option><option value="القادسية">القادسية</option>
                </select>

                <label style="font-weight:bold; font-size:0.9rem; margin-top:10px; display:block;">هل تحتاج خدمة تركيب؟</label>
                <select id="userInstall">
                    <option value="بدون تركيب">لا، بدون تركيب</option>
                    <option value="مع التركيب">نعم، أحتاج تركيب</option>
                </select>

                <label style="font-weight:bold; font-size:0.9rem; margin-top:10px; display:block;">طريقة الدفع:</label>
                <select id="userPayment"></select>
            </div>

            <div style="margin-top:20px;">
                <button class="btn-gold" style="width:100%; padding:20px;" onclick="sendOrder()">إرسال الطلب عبر واتساب</button>
                <p onclick="toggleCartModal()" style="margin-top:20px; text-align:center; color:#999; cursor:pointer; font-weight:bold;">إغلاق</p>
            </div>
        </div>
    </div>

    <!-- نافذة التعديل المنبثقة -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 id="editModalTitle">تعديل العنصر</h3>
                <button class="edit-modal-close" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="editFormContainer"></div>
        </div>
    </div>

    <!-- مستعرض المنتجات بنظام Alibaba -->
    <div class="alibaba-viewer-container" id="alibabaViewer" onclick="if(event.target===this) closeAlibabaViewer()">
        <div class="alibaba-viewer-content">
            <div class="alibaba-viewer-header">
                <div>
                    <h2 id="alibabaProductName">اسم المنتج</h2>
                    <span class="product-code" id="alibabaProductCode">موديل: ST-2024</span>
                </div>
                <button class="alibaba-viewer-close" onclick="closeAlibabaViewer()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="alibaba-viewer-body">
                <div class="alibaba-viewer-media">
                    <div class="alibaba-main-image-container" id="alibabaMainImageContainer"></div>
                    <div class="alibaba-thumbnail-gallery" id="alibabaThumbnailGallery"></div>
                </div>
                
                <div class="alibaba-viewer-info">
                    <h1 class="alibaba-product-title" id="alibabaProductTitle">اسم المنتج</h1>
                    
                    <div class="alibaba-product-meta">
                        <div class="alibaba-meta-item">
                            <i class="fas fa-star"></i>
                            <span id="alibabaProductRating">4.8 (128 تقييم)</span>
                        </div>
                        <div class="alibaba-meta-item">
                            <i class="fas fa-shopping-bag"></i>
                            <span id="alibabaProductSold">أكثر من 500 قطعة مباعة</span>
                        </div>
                    </div>
                    
                    <div class="alibaba-price-section">
                        <div class="alibaba-price-label">سعر المتر</div>
                        <div class="alibaba-price">
                            <span id="alibabaProductPrice">0</span>
                            <span class="alibaba-price-unit">د.ع</span>
                        </div>
                    </div>
                    
                    <!-- حقل الأمتار المحسن -->
                    <div class="alibaba-meters-section">
                        <div class="alibaba-meters-label">
                            <i class="fas fa-ruler"></i>
                            أدخل عدد الأمتار المطلوبة
                        </div>
                        <div class="alibaba-meters-input-group">
                            <input type="number" id="alibabaMetersInput" class="alibaba-meters-input" 
                                   placeholder="مثلاً: 5" min="0.5" step="0.5" value="1">
                            <span class="alibaba-meters-unit">متر</span>
                        </div>
                        <div class="alibaba-total-price">
                            <span class="alibaba-total-label">الإجمالي:</span>
                            <span class="alibaba-total-value" id="alibabaTotalPrice">0 د.ع</span>
                        </div>
                    </div>
                    
                    <div class="alibaba-action-buttons">
                        <button class="alibaba-add-to-cart-btn" onclick="addFromAlibabaViewer()">
                            <i class="fas fa-cart-plus"></i>
                            إضافة إلى السلة
                        </button>
                        <button class="alibaba-checkout-btn" onclick="checkoutFromAlibabaViewer()">
                            <i class="fas fa-credit-card"></i>
                            إتمام الطلب
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main id="mainContainer">
        <div id="homePage" class="page active">
            <!-- قسم الهيرو -->
            <section class="hero">
                <div class="hero-video-container">
                    <video class="hero-video" autoplay loop muted playsinline webkit-playsinline>
                        <source src="https://res.cloudinary.com/dnkuwf8q9/video/upload/v1772027160/gemini_generated_video_077d6d04_ehg756.mp4" type="video/mp4">
                    </video>
                    <div class="hero-overlay"></div>
                    
                    <div class="hero-content">
                        <h1>فخامة التفاصيل تبدأ من شبابيك منزلك</h1>
                        <div class="hero-btns">
                            <button onclick="document.getElementById('categories').scrollIntoView({behavior: 'smooth'})" class="btn-gold">احسب سعر ستائرك الآن</button>
                            <a href="https://wa.me/9647883002797" class="btn-trans"><i class="fab fa-whatsapp"></i> استشارة مجانية</a>
                        </div>
                        <div class="social-hero">
                            <a href="https://www.facebook.com/profile.php?id=61587692021311" target="_blank"><i class="fab fa-facebook"></i></a>
                            <a href="https://www.instagram.com/shababek.curtains/" target="_blank"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.tiktok.com/@shababek.curtains" target="_blank"><i class="fab fa-tiktok"></i></a>
                            <a href="https://youtube.com/@shababek.curtains?si=KKsEbL98N0fq2e2U" target="_blank"><i class="fab fa-youtube"></i></a>
                            <a href="https://x.com/ShababekCurtain" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
                            <a href="https://www.snapchat.com/add/shababekcurtin?share_id=B2Prmbx5_Xo&locale=en-IQ" target="_blank"><i class="fab fa-snapchat"></i></a>
                        </div>
                    </div>
                </div>
            </section>

            <section id="categories" style="padding: 40px 0;">
                <h2 style="text-align:center; font-weight:900; margin-bottom:15px;">أقسامنا المميزة</h2>
                <div id="categoriesList"></div>
            </section>
            <section class="features-section">
                <h2 style="margin-bottom:35px; font-weight:900;">لماذا شبابيك؟</h2>
                <div class="features-grid">
                    <div class="f-card"><i class="fa-solid fa-shield-halved" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>ضمان حقيقي</h3><p>أرقى الأقمشة بضمان رسمي.</p></div>
                    <div class="f-card"><i class="fa-solid fa-truck-fast" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>قياس منزلي</h3><p>نصلكم للقياس مجاناً.</p></div>
                    <div class="f-card"><i class="fa-solid fa-ruler-combined" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>تفصيل دقيق</h3><p>خياطة احترافية حسب الطلب.</p></div>
                    <div class="f-card"><i class="fa-solid fa-palette" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>ذوق رفيع</h3><p>أحدث الموديلات العصرية.</p></div>
                </div>
            </section>
        </div>

        <div id="adminPanel" class="page">
            <div style="padding: 40px 5%; max-width: 1200px; margin: auto;">
                <h2 style="text-align:center; margin-bottom:40px; font-weight:900;">لوحة التحكم - شبابيك</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                    <!-- إدارة الأقسام -->
                    <div class="admin-box" style="background: #f8f8f8; padding: 25px; border-radius: 20px;">
                        <h3 style="margin-bottom:20px; color:var(--gold); font-weight:900;">📁 إدارة الأقسام</h3>
                        <input type="text" id="admCatName" placeholder="اسم القسم الجديد" style="margin-bottom:10px;">
                        <input type="file" id="admCatFile" accept="image/*" style="margin-bottom:10px;">
                        <button onclick="publishCat()" class="btn-gold" style="width:100%; margin-bottom:20px;">➕ إضافة قسم</button>
                        <div id="admCatsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>

                    <!-- إدارة المنتجات مع رفع الفيديو -->
                    <div class="admin-box" style="background: #f8f8f8; padding: 25px; border-radius: 20px;">
                        <h3 style="margin-bottom:20px; color:var(--gold); font-weight:900;">🖼️ إدارة المنتجات</h3>
                        <select id="admProdCatSelect" style="margin-bottom:10px;"></select>
                        <input type="text" id="admProdName" placeholder="اسم المنتج" style="margin-bottom:10px;">
                        <input type="number" id="admProdPrice" placeholder="السعر" style="margin-bottom:10px;">
                        
                        <div style="margin:15px 0;">
                            <label style="font-weight:bold;">صور المنتج (متعددة)</label>
                            <input type="file" id="admProdImages" accept="image/*" multiple style="margin:10px 0;">
                        </div>
                        
                        <!-- رفع الفيديو مثل الصور -->
                        <div class="video-upload-container">
                            <label style="font-weight:bold; display:block; margin-bottom:10px;">
                                <i class="fas fa-video"></i> فيديو المنتج (رفع مباشر)
                            </label>
                            <input type="file" id="admProdVideo" accept="video/*" style="margin-bottom:10px;">
                            <small style="color: #666;">يمكنك رفع فيديو مباشرة وسيتم تحميله إلى Cloudinary</small>
                            <video id="videoPreview" controls style="width:100%; max-height:200px; margin-top:10px; display:none; border-radius:10px;"></video>
                        </div>
                        
                        <button onclick="publishProd()" class="btn-gold" style="width:100%; margin-bottom:20px;">➕ إضافة منتج</button>
                        <div id="admProdsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>

                    <!-- إدارة طرق الدفع -->
                    <div class="admin-box" style="background: #f8f8f8; padding: 25px; border-radius: 20px;">
                        <h3 style="margin-bottom:20px; color:var(--gold); font-weight:900;">💳 إدارة طرق الدفع</h3>
                        <input type="text" id="admPayName" placeholder="اسم طريقة الدفع" style="margin-bottom:10px;">
                        <input type="file" id="admPayFile" accept="image/*" style="margin-bottom:10px;">
                        <button onclick="publishPayment()" class="btn-gold" style="width:100%; margin-bottom:20px;">➕ إضافة طريقة دفع</button>
                        <div id="admPaysList" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="aboutPage" class="page">
            <div style="padding: 60px 5%; max-width: 1100px; margin: auto;">
                <h2 style="font-weight:900; font-size:2.5rem; margin-bottom:30px; text-align:center;">شبابيك للستائر</h2>
                <p style="font-size:1.2rem; line-height:2.2; color:#444; text-align:justify;">تأسست شبابيك للستائر بهدف تقديم أفخم وأجود أنواع الستائر المنزلية في العراق. نؤمن بأن الستائر ليست مجرد قطعة قماش، بل هي عنصر أساسي في تصميم المنزل يعكس ذوق أصحابه ويضيف لمسة من الأناقة والفخامة. نقدم مجموعة واسعة من الستائر تشمل البلاك أوت والشفافة والديكورية وستائر الرول، بأقمشة مستوردة من أفضل المصانع العالمية. كما نوفر خدمة التفصيل حسب المقاسات وخدمة التركيب المنزلي بأيدي فنيين متخصصين. رؤيتنا هي أن نكون الوجهة الأولى للستائر الفاخرة في العراق، ونسعى دائماً لتحقيق رضا عملائنا من خلال الجودة العالية والأسعار المنافسة والخدمة المتميزة.</p>
                <div class="stat-grid">
                    <div class="stat-card"><span class="stat-num">500+</span><p>عميل سعيد</p></div>
                    <div class="stat-card"><span class="stat-num">50+</span><p>تصميم حصري</p></div>
                    <div class="stat-card"><span class="stat-num">10+</span><p>سنوات خبرة</p></div>
                </div>
            </div>
        </div>
        
        <div id="contactPage" class="page">
            <div style="padding: 60px 5%; text-align: center; background: var(--bg); border-radius: 40px; margin: 40px 5%;">
                <h2 style="margin-bottom:30px; font-weight: 900; font-size: 2.2rem;">تواصل معنا</h2>
                <div><i class="fa-solid fa-phone"></i> 07883002797</div>
                <div style="margin-top:10px;"><i class="fa-solid fa-location-dot"></i> العراق - بغداد</div>
                <a href="https://wa.me/9647883002797" class="btn-gold" style="display:inline-block; text-decoration:none; margin-top:20px;">مراسلة واتساب مباشر</a>
            </div>
        </div>
        
        <div id="categoryView" class="page">
            <h2 id="catTitle" style="text-align:center; padding:40px 0; font-weight:900;"></h2>
            <div id="catGrid"></div>
        </div>
        
        <div id="productCalculator" class="page">
            <div style="padding:40px 5%; max-width:650px; margin:auto; text-align:center;">
                <img id="pImg" src="" style="width:100%; border-radius:25px; margin-bottom:25px;">
                <h2 id="pName"></h2>
                <div style="color:var(--gold); font-size:1.8rem; font-weight:900; margin-bottom:30px;"><span id="pPrice"></span> د.ع / متر</div>
                <!-- حقل الأمتار المحسن -->
                <input type="number" id="hIn" placeholder="أدخل الطول بالمتر" min="0.5" step="0.5" style="text-align:center;">
                <button onclick="addToCart()" class="btn-gold" style="width:100%;">إضافة للسلة</button>
                <button onclick="toggleCartModal()" style="background:transparent; border:2px solid var(--gold); color:var(--gold); width:100%; padding:18px; border-radius:12px; margin-top:10px;">إتمام الطلب الآن</button>
            </div>
        </div>
        
        <div id="paymentPage" class="page">
            <div style="padding: 40px 5%; text-align: center;">
                <h2 style="font-weight:900; margin-bottom:30px;">طرق الدفع الآمنة</h2>
                <div id="paymentList"></div>
            </div>
        </div>

        <!-- صفحة تعلم الطباعة المخفية -->
        <div id="typingPage" class="page">
            <div style="padding: 30px 5%; max-width: 1200px; margin: auto;">
                <!-- رأس الصفحة -->
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 style="font-size: 2.5rem; font-weight: 900; color: var(--brown);">💻 تعلم الطباعة السريعة</h2>
                    <p style="color: var(--gold); font-size: 1.2rem;">أكتب بسرعة وإتقان - تدرب يومياً 10 دقائق</p>
                </div>

                <!-- إحصائيات المتدرب -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(145deg, var(--gold), #c9a067); padding: 20px; border-radius: 20px; color: white; text-align: center;">
                        <i class="fas fa-tachometer-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div style="font-size: 2rem; font-weight: 900;" id="wpmCounter">0</div>
                        <div>كلمة في الدقيقة</div>
                    </div>
                    <div style="background: var(--brown); padding: 20px; border-radius: 20px; color: white; text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div style="font-size: 2rem; font-weight: 900;" id="accuracyCounter">100%</div>
                        <div>دقة الكتابة</div>
                    </div>
                    <div style="background: var(--teal); padding: 20px; border-radius: 20px; color: white; text-align: center;">
                        <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div style="font-size: 2rem; font-weight: 900;" id="timeCounter">0:00</div>
                        <div>الوقت</div>
                    </div>
                </div>

                <!-- اختيار المستوى -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="setLevel('easy')" class="level-btn" style="background: var(--teal); color: white; border: none; padding: 10px 25px; border-radius: 12px; font-weight: 700; cursor: pointer;">🥚 مبتدئ</button>
                    <button onclick="setLevel('medium')" class="level-btn" style="background: var(--gold); color: white; border: none; padding: 10px 25px; border-radius: 12px; font-weight: 700; cursor: pointer;">🚀 متوسط</button>
                    <button onclick="setLevel('hard')" class="level-btn" style="background: var(--red); color: white; border: none; padding: 10px 25px; border-radius: 12px; font-weight: 700; cursor: pointer;">⚡ محترف</button>
                </div>

                <!-- النص المطلوب كتابته -->
                <div style="background: #f8f8f8; padding: 30px; border-radius: 20px; margin-bottom: 20px; border: 3px solid var(--gold);">
                    <h3 style="margin-bottom: 15px; color: var(--brown);">📝 انسخ هذا النص:</h3>
                    <div id="targetText" style="font-size: 1.5rem; line-height: 2; direction: ltr; text-align: left; font-family: monospace; background: white; padding: 20px; border-radius: 12px; color: #333;">
                        شبابيك للستائر - ظل وذوق
                    </div>
                </div>

                <!-- منطقة الكتابة -->
                <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: var(--brown);">⌨️ اكتب هنا:</h3>
                    <textarea id="typingArea" rows="4" placeholder="ابدأ الكتابة هنا..." oninput="checkTyping()"></textarea>
                </div>

                <!-- لوحة المفاتيح التفاعلية -->
                <div class="keyboard-container">
                    <div class="keyboard-row">
                        <div class="key">`</div><div class="key">1</div><div class="key">2</div><div class="key">3</div><div class="key">4</div><div class="key">5</div><div class="key">6</div><div class="key">7</div><div class="key">8</div><div class="key">9</div><div class="key">0</div><div class="key">-</div><div class="key">=</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key">q</div><div class="key">w</div><div class="key">e</div><div class="key">r</div><div class="key">t</div><div class="key">y</div><div class="key">u</div><div class="key">i</div><div class="key">o</div><div class="key">p</div><div class="key">[</div><div class="key">]</div><div class="key">\</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key">a</div><div class="key">s</div><div class="key">d</div><div class="key">f</div><div class="key">g</div><div class="key">h</div><div class="key">j</div><div class="key">k</div><div class="key">l</div><div class="key">;</div><div class="key">'</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key">z</div><div class="key">x</div><div class="key">c</div><div class="key">v</div><div class="key">b</div><div class="key">n</div><div class="key">m</div><div class="key">,</div><div class="key">.</div><div class="key">/</div>
                    </div>
                    <div class="keyboard-row space-row">
                        <div class="key space">مسافة</div>
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                    <button onclick="resetTypingTest()" class="btn-gold" style="padding: 15px 30px;">
                        <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                    <button onclick="showNewText()" class="btn-gold" style="background: var(--teal); padding: 15px 30px;">
                        <i class="fas fa-random"></i> نص جديد
                    </button>
                </div>

                <!-- جدول التقدم -->
                <div style="margin-top: 40px; background: #f8f8f8; padding: 20px; border-radius: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--brown);">📊 تقدم التعلم</h3>
                    <div id="progressHistory"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="footer-cta">
        <h2>جاهز لتجديد ستائر منزلك؟</h2>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
            <a href="https://wa.me/9647883002797" class="btn-footer-wa">تواصل عبر واتساب</a>
            <a onclick="showPage('homePage'); document.getElementById('categories').scrollIntoView({behavior: 'smooth'})" class="btn-footer-prod">تصفح المنتجات</a>
        </div>
    </div>

    <footer>
        <div style="font-size:1.8rem; font-weight:900; color:var(--gold); margin-bottom:10px;">شبابيك</div>
        <p>© 2026 جميع الحقوق محفوظة لشبابيك للستائر - ظل وذوق</p>
    </footer>

    <script>
        // تهيئة Firebase
        const firebaseConfig = { 
            apiKey: "AIzaSyD1TENeV6RkWmrYIjV6seGx84VavsM_tvE", 
            authDomain: "shababekcurtain.firebaseapp.com", 
            databaseURL: "https://shababekcurtain-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            projectId: "shababekcurtain" 
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // متغيرات عامة
        const CLOUD_NAME = "dnkuwf8q9";
        const UPLOAD_PRESET = "afsx4w9k";
        const LOGO_ID = "shababek_logo";
        let currentProduct = null;
        let cart = JSON.parse(localStorage.getItem('shababek_cart')) || [];
        let adminClicks = 0;
        let clickTimer;
        let currentEditItem = null;
        let currentEditType = null;
        
        // متغيرات صفحة التعلم
        let typingTimer;
        let startTime;
        let isTypingActive = false;
        let currentLevel = 'easy';
        let typedChars = 0;
        let wrongChars = 0;
        let completedExercises = JSON.parse(localStorage.getItem('typing_progress')) || [];
        
        // متغير للدخول المخفي
        let typingClicks = 0;
        let typingClickTimer;

        // نظام التخزين المؤقت
        let cache = {
            categories: null,
            products: null,
            payments: null,
            lastFetch: 0
        };

        // نصوص للتدريب حسب المستوى
        const typingTexts = {
            easy: [
                "شبابيك للستائر - ظل وذوق",
                "مرحباً بك في عالم الطباعة السريعة",
                "القطط تحب اللعب بالكرات الصغيرة",
                "أنا أتعلم الطباعة على لوحة المفاتيح",
                "الكتابة السريعة مهارة رائعة",
                "السماء زرقاء والشمس مشرقة اليوم",
                "أحب القراءة والكتابة بالعربية"
            ],
            medium: [
                "شبابيك للستائر تقدم أفخم الستائر المنزلية في العراق",
                "الطباعة السريعة تحتاج إلى تدريب يومي مستمر",
                "القطط حيوانات أليفة نظيفة ولطيفة وتحب اللعب",
                "الكتابة باللمس مهارة ضرورية في العصر الرقمي",
                "التدريب المنتظم يحسن سرعة ودقة الطباعة بشكل ملحوظ"
            ],
            hard: [
                "شبابيك للستائر - ظل وذوق، تأسست بهدف تقديم أفخم وأجود أنواع الستائر",
                "الطباعة السريعة هي فن إدخال النصوص بسرعة ودقة دون النظر إلى لوحة المفاتيح",
                "التكنولوجيا الحديثة غيرت طريقة تواصلنا وأصبحت الكتابة مهارة أساسية للجميع",
                "التدريب اليومي لمدة 10 دقائق يحسن سرعة الطباعة بنسبة 50% خلال شهر واحد"
            ]
        };

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function getCachedData(ref) {
            const now = Date.now();
            if (cache[ref] && (now - cache.lastFetch) < 300000) {
                return cache[ref];
            }
            
            const snapshot = await db.ref(ref).once('value');
            cache[ref] = snapshot.val() || {};
            cache.lastFetch = now;
            return cache[ref];
        }

        function getValue(id) { 
            const el = document.getElementById(id);
            return el ? el.value : ""; 
        }

        function showPage(pageId, pushToHistory = true) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                window.scrollTo(0, 0);
                
                if (pushToHistory) {
                    history.pushState({ page: pageId }, '', `#${pageId}`);
                }
            }
        }

        // تعديل دالة النقر على الشعار لفتح صفحة التعلم بكلمة السر
        function handleLogoClick() {
            typingClicks++;
            clearTimeout(typingClickTimer);
            
            typingClickTimer = setTimeout(() => {
                if (typingClicks === 3) {
                    const pass = prompt("🔐 أدخل كلمة السر لفتح صفحة تعلم الطباعة:");
                    if (pass === "2016") {
                        showPage('typingPage');
                        confetti({ particleCount: 100, spread: 70 });
                        // تهيئة صفحة التعلم
                        setTimeout(() => {
                            showNewText();
                            updateProgressHistory();
                        }, 100);
                    } else if (pass !== null) {
                        alert("❌ كلمة السر غير صحيحة!");
                    }
                }
                typingClicks = 0;
            }, 500);
            
            // للحفاظ على وظيفة adminPanel القديمة
            adminClicks++;
            clearTimeout(clickTimer);
            
            if (adminClicks >= 5) {
                adminClicks = 0;
                const adminPass = prompt("🔐 أدخل رمز الدخول السحابي:");
                if (adminPass === "8496") {
                    showPage('adminPanel');
                    confetti({ particleCount: 100, spread: 70 });
                } else if (adminPass !== null) { 
                    alert("❌ الرمز غير صحيح!"); 
                }
                return;
            }
            
            clickTimer = setTimeout(() => {
                if (adminClicks === 1) showPage('homePage');
                adminClicks = 0;
            }, 400);
        }

        async function uploadFile(file) {
            if (!file) return "";
            
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);
            
            const resourceType = file.type.startsWith('video/') ? 'video' : 'image';
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`, { 
                    method: "POST", 
                    body: formData 
                });
                const data = await res.json();
                return data.secure_url;
            } catch (error) {
                console.error("خطأ في رفع الملف:", error);
                alert("فشل في رفع الملف");
                return "";
            }
        }

        // معاينة الفيديو قبل الرفع
        document.getElementById('admProdVideo')?.addEventListener('change', function(e) {
            const video = document.getElementById('videoPreview');
            if (e.target.files[0]) {
                video.src = URL.createObjectURL(e.target.files[0]);
                video.style.display = 'block';
            } else {
                video.style.display = 'none';
            }
        });

        function getWatermarkedUrl(url, type = 'image') {
            if (!url) return url;
            
            if (url.includes("cloudinary.com")) {
                const watermarkTransform = `l_${LOGO_ID},o_40,g_south_east,w_0.3,fl_relative,x_5,y_5,fl_layer_apply`;
                
                if (type === 'video') {
                    return url.replace("/video/upload/", `/video/upload/${watermarkTransform}/`);
                } else {
                    return url.replace("/image/upload/", `/image/upload/${watermarkTransform}/`);
                }
            }
            
            return url;
        }

        // ===== دوال التعديل =====
        function openEditModal(type, id, data) {
            currentEditType = type;
            currentEditItem = { id, ...data };
            
            const modal = document.getElementById('editModal');
            const title = document.getElementById('editModalTitle');
            const formContainer = document.getElementById('editFormContainer');
            
            title.innerText = type === 'category' ? '✏️ تعديل القسم' : 
                              type === 'product' ? '✏️ تعديل المنتج' : '✏️ تعديل طريقة الدفع';
            
            if (type === 'category') {
                formContainer.innerHTML = `
                    <div class="edit-form-group">
                        <label>اسم القسم</label>
                        <input type="text" id="editCatName" value="${data.name || ''}">
                    </div>
                    <div class="edit-form-group">
                        <label>صورة القسم</label>
                        <input type="file" id="editCatFile" accept="image/*">
                        <div class="image-preview-container">
                            <img src="${data.img}" class="image-preview" id="editCatPreview">
                        </div>
                    </div>
                    <button class="edit-save-btn" onclick="saveEdit()">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                `;
            } else if (type === 'product') {
                formContainer.innerHTML = `
                    <div class="edit-form-group">
                        <label>اسم المنتج</label>
                        <input type="text" id="editProdName" value="${data.name || ''}">
                    </div>
                    <div class="edit-form-group">
                        <label>السعر</label>
                        <input type="number" id="editProdPrice" value="${data.price || ''}">
                    </div>
                    <div class="edit-form-group">
                        <label>القسم</label>
                        <select id="editProdCatSelect"></select>
                    </div>
                    <div class="edit-form-group">
                        <label>صورة المنتج</label>
                        <input type="file" id="editProdFile" accept="image/*">
                        <div class="image-preview-container">
                            <img src="${data.img || (data.images && data.images[0])}" class="image-preview" id="editProdPreview">
                        </div>
                    </div>
                    <div class="edit-form-group">
                        <label>فيديو المنتج</label>
                        <input type="file" id="editProdVideo" accept="video/*">
                        ${data.video ? `<video src="${data.video}" controls style="width:100%; max-height:200px; margin-top:10px; border-radius:10px;"></video>` : ''}
                    </div>
                    <button class="edit-save-btn" onclick="saveEdit()">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                `;
                
                setTimeout(() => {
                    getCachedData('categories').then(cats => {
                        const select = document.getElementById('editProdCatSelect');
                        if (select) {
                            select.innerHTML = '<option value="">اختر القسم</option>' +
                                Object.values(cats || {}).map(cat => 
                                    `<option value="${cat.name}" ${cat.name === data.category ? 'selected' : ''}>${cat.name}</option>`
                                ).join('');
                        }
                    });
                }, 100);
            } else if (type === 'payment') {
                formContainer.innerHTML = `
                    <div class="edit-form-group">
                        <label>اسم طريقة الدفع</label>
                        <input type="text" id="editPayName" value="${data.name || ''}">
                    </div>
                    <div class="edit-form-group">
                        <label>شعار طريقة الدفع</label>
                        <input type="file" id="editPayFile" accept="image/*">
                        <div class="image-preview-container">
                            <img src="${data.img}" class="image-preview" id="editPayPreview">
                        </div>
                    </div>
                    <button class="edit-save-btn" onclick="saveEdit()">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                `;
            }
            
            modal.classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditItem = null;
            currentEditType = null;
        }

        async function saveEdit() {
            if (!currentEditItem || !currentEditType) return;
            
            try {
                if (currentEditType === 'category') {
                    const newName = document.getElementById('editCatName').value;
                    const file = document.getElementById('editCatFile').files[0];
                    
                    let updates = { name: newName };
                    
                    if (file) {
                        const url = await uploadFile(file);
                        if (url) updates.img = url;
                    }
                    
                    await db.ref('categories').child(currentEditItem.id).update(updates);
                    alert('✅ تم تعديل القسم بنجاح');
                    
                } else if (currentEditType === 'product') {
                    const newName = document.getElementById('editProdName').value;
                    const newPrice = document.getElementById('editProdPrice').value;
                    const newCat = document.getElementById('editProdCatSelect').value;
                    const videoFile = document.getElementById('editProdVideo').files[0];
                    const imageFile = document.getElementById('editProdFile').files[0];
                    
                    let updates = { 
                        name: newName, 
                        price: parseInt(newPrice),
                        category: newCat
                    };
                    
                    if (videoFile) {
                        const videoUrl = await uploadFile(videoFile);
                        if (videoUrl) updates.video = videoUrl;
                    }
                    
                    if (imageFile) {
                        const imgUrl = await uploadFile(imageFile);
                        if (imgUrl) {
                            updates.img = imgUrl;
                            updates.images = [imgUrl];
                        }
                    }
                    
                    await db.ref('products').child(currentEditItem.id).update(updates);
                    alert('✅ تم تعديل المنتج بنجاح');
                    
                } else if (currentEditType === 'payment') {
                    const newName = document.getElementById('editPayName').value;
                    const file = document.getElementById('editPayFile').files[0];
                    
                    let updates = { name: newName };
                    
                    if (file) {
                        const url = await uploadFile(file);
                        if (url) updates.img = url;
                    }
                    
                    await db.ref('payments').child(currentEditItem.id).update(updates);
                    alert('✅ تم تعديل طريقة الدفع بنجاح');
                }
                
                cache.categories = null;
                cache.products = null;
                cache.payments = null;
                
                closeEditModal();
                loadAdminData();
                
            } catch (error) {
                console.error("خطأ في التعديل:", error);
                alert("❌ فشل التعديل");
            }
        }

        function deleteItem(ref, key) { 
            if(confirm("⚠️ هل أنت متأكد من حذف هذا العنصر نهائياً؟")) {
                db.ref(ref).child(key).remove().then(() => {
                    alert("✅ تم الحذف بنجاح");
                    if (ref === 'categories') cache.categories = null;
                    if (ref === 'products') cache.products = null;
                    if (ref === 'payments') cache.payments = null;
                    loadAdminData();
                });
            }
        }

        async function handleSmartSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const suggestions = document.getElementById('searchSuggestions');
            
            if (query.length < 2) { 
                suggestions.style.display = 'none';
                return; 
            }

            const products = await getCachedData('products') || {};
            
            const results = Object.values(products).filter(p => 
                p.name?.toLowerCase().includes(query) || 
                p.category?.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (results.length > 0) {
                suggestions.innerHTML = results.map(p => `
                    <div onclick='openCalc(${JSON.stringify(p).replace(/'/g, "&apos;")}); suggestions.style.display="none"; document.getElementById("searchInput").value=""'>
                        <img src="${getWatermarkedUrl(p.img || (p.images && p.images[0]), 'image')}" loading="lazy">
                        <span>${p.name}</span>
                        <small>${p.category}</small>
                    </div>
                `).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        async function publishCat() {
            const file = document.getElementById('admCatFile').files[0];
            const name = getValue('admCatName');
            
            if(!file || !name) {
                alert("أكمل بيانات القسم");
                return;
            }
            
            const url = await uploadFile(file);
            if (url) {
                db.ref('categories').push({name: name, img: url}).then(() => {
                    alert("✅ تم إضافة القسم بنجاح");
                    document.getElementById('admCatName').value = "";
                    document.getElementById('admCatFile').value = "";
                    cache.categories = null;
                    loadAdminData();
                });
            }
        }

        function addVideoInput() {
            const container = document.getElementById('videoInputsContainer');
            const newIndex = container.children.length + 1;
            
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            
            div.innerHTML = `
                <input type="url" class="admProdVideo" placeholder="رابط فيديو ${newIndex}" style="flex:1;">
                <button onclick="removeVideoInput(this)" style="background: var(--red); color: white; border: none; width: 40px; border-radius: 8px;">-</button>
            `;
            
            container.appendChild(div);
        }

        function removeVideoInput(button) {
            if (document.querySelectorAll('.admProdVideo').length > 1) {
                button.parentElement.remove();
            }
        }

        async function publishProd() {
            const imageFiles = document.getElementById('admProdImages').files;
            const videoFile = document.getElementById('admProdVideo').files[0];
            const cat = document.getElementById('admProdCatSelect').value;
            const name = getValue('admProdName');
            const price = getValue('admProdPrice');
            
            if(imageFiles.length === 0 || !name || !price || !cat) {
                alert("أكمل بيانات المنتج (صورة واحدة على الأقل)");
                return;
            }
            
            const imageUrls = [];
            for (let i = 0; i < imageFiles.length; i++) {
                const url = await uploadFile(imageFiles[i]);
                if (url) {
                    imageUrls.push(url);
                }
            }
            
            let videoUrl = '';
            if (videoFile) {
                videoUrl = await uploadFile(videoFile);
            }
            
            if (imageUrls.length > 0) {
                const productData = { 
                    category: cat, 
                    name: name, 
                    price: parseInt(price), 
                    images: imageUrls,
                    img: imageUrls[0]
                };
                
                if (videoUrl) {
                    productData.video = videoUrl;
                    productData.videos = [videoUrl];
                }
                
                db.ref('products').push(productData).then(() => {
                    alert(`✅ تم نشر المنتج بنجاح!`);
                    
                    document.getElementById('admProdName').value = "";
                    document.getElementById('admProdPrice').value = "";
                    document.getElementById('admProdImages').value = "";
                    document.getElementById('admProdVideo').value = "";
                    document.getElementById('videoPreview').style.display = 'none';
                    
                    cache.products = null;
                    loadAdminData();
                });
            }
        }

        async function publishPayment() {
            const file = document.getElementById('admPayFile').files[0];
            const name = getValue('admPayName');
            
            if(!file || !name) {
                alert("أكمل بيانات طريقة الدفع");
                return;
            }
            
            const url = await uploadFile(file);
            if (url) {
                db.ref('payments').push({ 
                    name: name, 
                    img: url 
                }).then(() => {
                    alert("✅ تم إضافة طريقة الدفع بنجاح");
                    document.getElementById('admPayName').value = "";
                    document.getElementById('admPayFile').value = "";
                    cache.payments = null;
                    loadAdminData();
                });
            }
        }

        function loadAdminData() {
            // تحميل الأقسام
            getCachedData('categories').then(cats => {
                const admCatsList = document.getElementById('admCatsList');
                if(admCatsList) {
                    admCatsList.innerHTML = Object.entries(cats || {}).map(([key, cat]) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border-radius:10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${cat.img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                                <span>${cat.name}</span>
                            </div>
                            <div>
                                <button class="edit-btn" onclick='openEditModal("category", "${key}", ${JSON.stringify(cat).replace(/'/g, "&apos;")})' style="background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:5px; margin-left:5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" onclick="deleteItem('categories','${key}')" style="background:var(--red); color:white; border:none; padding:5px 10px; border-radius:5px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                const admProdCatSelect = document.getElementById('admProdCatSelect');
                if(admProdCatSelect) {
                    admProdCatSelect.innerHTML = '<option value="">اختر قسم</option>' + 
                        Object.values(cats || {}).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                }
            });

            // تحميل المنتجات
            getCachedData('products').then(data => {
                const admProdsList = document.getElementById('admProdsList');
                if(admProdsList) {
                    admProdsList.innerHTML = Object.entries(data || {}).map(([key, prod]) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border-radius:10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${prod.img || (prod.images && prod.images[0])}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                                <div>
                                    <strong>${prod.name}</strong><br>
                                    <small style="color:var(--gold);">${prod.price} د.ع</small>
                                    ${prod.video ? '<small style="color:var(--blue);"><i class="fas fa-video"></i> فيديو</small>' : ''}
                                </div>
                            </div>
                            <div>
                                <button class="edit-btn" onclick='openEditModal("product", "${key}", ${JSON.stringify(prod).replace(/'/g, "&apos;")})' style="background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:5px; margin-left:5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" onclick="deleteItem('products','${key}')" style="background:var(--red); color:white; border:none; padding:5px 10px; border-radius:5px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            });

            // تحميل طرق الدفع
            getCachedData('payments').then(data => {
                const admPaysList = document.getElementById('admPaysList');
                if(admPaysList) {
                    admPaysList.innerHTML = Object.entries(data || {}).map(([key, pay]) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border-radius:10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${pay.img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                                <span>${pay.name}</span>
                            </div>
                            <div>
                                <button class="edit-btn" onclick='openEditModal("payment", "${key}", ${JSON.stringify(pay).replace(/'/g, "&apos;")})' style="background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:5px; margin-left:5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" onclick="deleteItem('payments','${key}')" style="background:var(--red); color:white; border:none; padding:5px 10px; border-radius:5px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            });
        }

        function openCat(categoryName) { 
            localStorage.setItem('lastCat', categoryName);
            getCachedData('products').then(products => {
                const items = Object.values(products || {}).filter(i => i.category === categoryName); 
                document.getElementById('catTitle').innerText = categoryName; 
                
                if (items.length === 0) {
                    document.getElementById('catGrid').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;">لا توجد منتجات في هذا القسم</div>';
                } else {
                    document.getElementById('catGrid').innerHTML = items.map(x => `
                        <div class="cat-card-new" onclick='openCalc(${JSON.stringify(x).replace(/'/g, "&apos;")})'>
                            <img src="${getWatermarkedUrl(x.img || (x.images && x.images[0]), 'image')}" loading="lazy">
                            <div style="padding:20px;text-align:center;">
                                <h3>${x.name}</h3>
                                ${x.video ? '<i class="fas fa-video" style="color:var(--gold); margin:5px 0;"></i>' : ''}
                                <p style="color:var(--gold);font-weight:900;">${parseInt(x.price).toLocaleString()} د.ع</p>
                            </div>
                        </div>`).join('');
                }
                showPage('categoryView'); 
            }); 
        }

        function openCalc(product) { 
            currentProduct = product; 
            localStorage.setItem('lastProd', JSON.stringify(product));

            const mediaItems = [];

            if (product.video) {
                mediaItems.push({ type: 'video', url: getWatermarkedUrl(product.video, 'video') });
            }

            if (product.images && Array.isArray(product.images)) {
                product.images.forEach(img => {
                    mediaItems.push({ type: 'image', url: getWatermarkedUrl(img, 'image') });
                });
            } else if (product.img) {
                mediaItems.push({ type: 'image', url: getWatermarkedUrl(product.img, 'image') });
            }

            openAlibabaViewer({ ...product, mediaItems: mediaItems });

            document.getElementById('pName').innerText = product.name;
            document.getElementById('pPrice').innerText = parseInt(product.price).toLocaleString();
            document.getElementById('pImg').src = getWatermarkedUrl(product.img || (product.images && product.images[0]), 'image');
            document.getElementById('hIn').value = '';
            
            showPage('productCalculator');
        }

        function addToCart() {
            const h = parseFloat(document.getElementById('hIn').value);
            if(!h || h <= 0) return alert("أدخل الطول بالمتر");
            if(!currentProduct) return alert("حدث خطأ");
            
            cart.push({ 
                n: currentProduct.name, 
                p: Math.round(h * currentProduct.price), 
                img: getWatermarkedUrl(currentProduct.img || (currentProduct.images && currentProduct.images[0]), 'image'),
                length: h
            });
            
            document.getElementById('globalCartCount').innerText = cart.length; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            
            const cartIcon = document.querySelector('.cart-icon');
            cartIcon.style.transform = 'scale(1.2) rotate(10deg)';
            setTimeout(() => {
                cartIcon.style.transform = '';
            }, 200);
            
            alert("✅ تمت الإضافة للسلة!");
            document.getElementById('hIn').value = '';
        }

        function toggleCartModal() {
            const overlay = document.getElementById('cartOverlay');
            overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
            
            if (overlay.style.display === 'flex') {
                let total = 0;
                let html = '';
                
                cart.forEach((item, idx) => {
                    total += item.p;
                    html += `<div class="cart-item" style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #eee;">
                        <img src="${item.img}" loading="lazy" style="width:50px;height:50px;border-radius:8px;object-fit:cover;">
                        <div style="flex:1;"><b>${item.n}</b><br><span style="color:var(--gold)">${item.p.toLocaleString()} د.ع</span></div>
                        <i class="fas fa-trash" style="color:red;cursor:pointer;" onclick="removeFromCart(${idx})"></i>
                    </div>`;
                });
                
                if (cart.length > 0) {
                    html += `<div style="margin-top:15px;font-weight:900;text-align:center;background:#eee;padding:10px;">الإجمالي: ${total.toLocaleString()} د.ع</div>`;
                } else {
                    html = '<p style="text-align:center;padding:20px;">السلة فارغة</p>';
                }
                
                document.getElementById('cartItemsList').innerHTML = html;
            }
        }

        function removeFromCart(index) { 
            cart.splice(index, 1); 
            document.getElementById('globalCartCount').innerText = cart.length; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            toggleCartModal(); 
        }

        function sendOrder() {
            if(cart.length === 0) return alert("السلة فارغة");
            
            const city = document.getElementById('userCity').value;
            const payment = document.getElementById('userPayment').value;
            const install = document.getElementById('userInstall').value;

            let msg = `*طلب شراء جديد من شبابيك للستائر* 🪟\n\n`;
            msg += `📍 *المحافظة:* ${city}\n`;
            msg += `🛠 *خدمة التركيب:* ${install}\n`;
            msg += `💳 *طريقة الدفع:* ${payment}\n`;
            msg += `------------------------------\n\n`;
            
            let total = 0;

            cart.forEach((item, index) => {
                msg += `*${index + 1}- الموديل:* ${item.n}\n`;
                msg += `💰 *السعر:* ${item.p.toLocaleString()} د.ع\n`;
                msg += `------------------------------\n`;
                total += item.p;
            });
            
            msg += `\n💰 *الإجمالي الكلي للطلب:* ${total.toLocaleString()} د.ع\n\n`;
            msg += `_شكراً لاختياركم شبابيك - ظل وذوق_`;

            const waNumber = "9647883002797";
            const encodedMsg = encodeURIComponent(msg);
            
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            const waIntentUrl = `intent://send?phone=${waNumber}&text=${encodedMsg}#Intent;package=com.whatsapp;scheme=whatsapp;end;`;
            const waIosUrl = `whatsapp://send?phone=${waNumber}&text=${encodedMsg}`;
            const waWebUrl = `https://wa.me/${waNumber}?text=${encodedMsg}`;
            
            if (isMobile) {
                if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    window.location.href = waIosUrl;
                    setTimeout(() => {
                        window.location.href = waWebUrl;
                    }, 1000);
                } 
                else if (/Android/i.test(navigator.userAgent)) {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = waIntentUrl;
                    document.body.appendChild(iframe);
                    
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        window.location.href = waWebUrl;
                    }, 1000);
                }
            } else {
                window.open(waWebUrl, '_blank');
            }

            cart = []; 
            document.getElementById('globalCartCount').innerText = "0"; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            toggleCartModal();
        }

        // ===== دوال صفحة تعلم الطباعة =====
        function setLevel(level) {
            currentLevel = level;
            
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = '';
            });
            event.target.classList.add('active');
            
            showNewText();
        }

        function showNewText() {
            const texts = typingTexts[currentLevel];
            const randomIndex = Math.floor(Math.random() * texts.length);
            const targetText = document.getElementById('targetText');
            
            targetText.innerHTML = texts[randomIndex].split('').map(char => 
                `<span class="target-char">${char}</span>`
            ).join('');
            
            document.getElementById('typingArea').value = '';
            document.getElementById('typingArea').focus();
            resetTypingTest();
        }

        function checkTyping() {
            const input = document.getElementById('typingArea').value;
            const targetChars = document.querySelectorAll('.target-char');
            const targetText = Array.from(targetChars).map(span => span.textContent).join('');
            
            if (!isTypingActive && input.length > 0) {
                startTypingTimer();
            }
            
            let correctCount = 0;
            let wrongCount = 0;
            
            for (let i = 0; i < targetChars.length; i++) {
                if (i < input.length) {
                    if (input[i] === targetText[i]) {
                        targetChars[i].className = 'target-char correct-char';
                        correctCount++;
                    } else {
                        targetChars[i].className = 'target-char wrong-char';
                        wrongCount++;
                    }
                } else {
                    targetChars[i].className = 'target-char';
                }
            }
            
            typedChars = input.length;
            wrongChars = wrongCount;
            
            const accuracy = typedChars > 0 ? ((typedChars - wrongChars) / typedChars * 100).toFixed(1) : 100;
            document.getElementById('accuracyCounter').textContent = accuracy + '%';
            
            if (input.length === targetText.length && wrongCount === 0) {
                completeExercise();
            }
            
            highlightKeyboard(input.slice(-1));
        }

        function startTypingTimer() {
            isTypingActive = true;
            startTime = Date.now();
            
            typingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timeCounter').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (elapsed > 0) {
                    const wpm = Math.round((typedChars / 5) / (elapsed / 60));
                    document.getElementById('wpmCounter').textContent = wpm;
                }
            }, 1000);
        }

        function completeExercise() {
            clearInterval(typingTimer);
            isTypingActive = false;
            
            const timeElapsed = Math.floor((Date.now() - startTime) / 1000);
            const wpm = Math.round((typedChars / 5) / (timeElapsed / 60));
            const accuracy = ((typedChars - wrongChars) / typedChars * 100).toFixed(1);
            
            const progress = {
                date: new Date().toLocaleDateString('ar-IQ'),
                level: currentLevel,
                wpm: wpm,
                accuracy: accuracy,
                time: timeElapsed
            };
            
            completedExercises.push(progress);
            localStorage.setItem('typing_progress', JSON.stringify(completedExercises));
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            alert(`🎉 أحسنت! أكملت التمرين بنجاح\n⚡ السرعة: ${wpm} كلمة/دقيقة\n🎯 الدقة: ${accuracy}%\n⏱️ الوقت: ${timeElapsed} ثانية`);
            
            updateProgressHistory();
            showNewText();
        }

        function resetTypingTest() {
            clearInterval(typingTimer);
            isTypingActive = false;
            typedChars = 0;
            wrongChars = 0;
            document.getElementById('typingArea').value = '';
            document.getElementById('timeCounter').textContent = '0:00';
            document.getElementById('wpmCounter').textContent = '0';
            document.getElementById('accuracyCounter').textContent = '100%';
            
            document.querySelectorAll('.target-char').forEach(span => {
                span.className = 'target-char';
            });
        }

        function highlightKeyboard(lastChar) {
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('active');
            });
            
            if (lastChar) {
                const key = Array.from(document.querySelectorAll('.key')).find(k => 
                    k.textContent === lastChar || (lastChar === ' ' && k.classList.contains('space'))
                );
                if (key) {
                    key.classList.add('active');
                    setTimeout(() => key.classList.remove('active'), 100);
                }
            }
        }

        function updateProgressHistory() {
            const historyDiv = document.getElementById('progressHistory');
            const recent = completedExercises.slice(-10).reverse();
            
            if (recent.length === 0) {
                historyDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد تدريبات سابقة. ابدأ الآن!</p>';
                return;
            }
            
            historyDiv.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; text-align: center; background: white; border-radius: 12px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--brown); color: white;">
                                <th style="padding: 12px;">التاريخ</th>
                                <th style="padding: 12px;">المستوى</th>
                                <th style="padding: 12px;">السرعة</th>
                                <th style="padding: 12px;">الدقة</th>
                                <th style="padding: 12px;">الوقت</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recent.map(p => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px;">${p.date}</td>
                                    <td style="padding: 10px;">
                                        ${p.level === 'easy' ? '🥚' : p.level === 'medium' ? '🚀' : '⚡'}
                                    </td>
                                    <td style="padding: 10px; font-weight: bold; color: var(--teal);">${p.wpm} ك/د</td>
                                    <td style="padding: 10px; color: var(--gold);">${p.accuracy}%</td>
                                    <td style="padding: 10px;">${p.time} ث</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('typingPage').classList.contains('active')) {
                e.preventDefault();
                const key = e.key.length === 1 ? e.key : e.key === ' ' ? 'مسافة' : '';
                highlightKeyboard(key === 'مسافة' ? ' ' : key);
            }
        });

        const heroVideo = document.querySelector('.hero-video');
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                heroVideo.pause();
            } else {
                heroVideo.play().catch(() => {});
            }
        });

        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            const suggestions = document.getElementById('searchSuggestions');
            if (searchContainer && !searchContainer.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.page) {
                showPage(event.state.page, false); 
            } else {
                showPage('homePage', false);
            }
        });

        window.addEventListener('load', () => {
            // الأقسام للمستخدم
            getCachedData('categories').then(cats => {
                const list = document.getElementById('categoriesList');
                if(list) {
                    if (!cats || Object.keys(cats).length === 0) {
                        list.innerHTML = '<div style="grid-column:1/-1; text-align:center;">لا توجد أقسام</div>';
                    } else {
                        list.innerHTML = Object.values(cats).map(c => 
                            `<div class="cat-card-new" onclick="openCat('${c.name}')">
                                <img src="${c.img}" loading="lazy">
                                <div style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:var(--gold);color:white;padding:10px 25px;border-radius:12px;font-weight:900;">${c.name}</div>
                            </div>`
                        ).join('');
                    }
                }
            });

            // طرق الدفع للمستخدم
            getCachedData('payments').then(data => {
                const userList = document.getElementById('paymentList');
                const selectBox = document.getElementById('userPayment');

                if(selectBox) {
                    selectBox.innerHTML = Object.values(data || {}).map(pay => 
                        `<option value="${pay.name}">${pay.name}</option>`
                    ).join('') || '<option value="نقد عند الاستلام">نقد عند الاستلام</option>';
                }

                if(userList) {
                    if (!data || Object.keys(data).length === 0) {
                        userList.innerHTML = '<div style="grid-column:1/-1; text-align:center;">لا توجد طرق دفع</div>';
                    } else {
                        userList.innerHTML = Object.values(data).map(pay => `
                            <div class="payment-card">
                                <img src="${pay.img}" loading="lazy">
                                <div class="payment-overlay">${pay.name}</div>
                            </div>
                        `).join('');
                    }
                }
            });

            const hash = location.hash.replace('#', '');
            if (hash === 'categoryView') {
                const lastCat = localStorage.getItem('lastCat');
                if(lastCat) openCat(lastCat);
            } else if (hash === 'productCalculator') {
                const lastProd = localStorage.getItem('lastProd');
                if(lastProd) openCalc(JSON.parse(lastProd));
            } else {
                showPage(hash || 'homePage', false);
            }

            document.getElementById('globalCartCount').innerText = cart.length;
            setupAlibabaViewerEvents();
            loadAdminData();
            updateProgressHistory();
        });

        // ===== نظام المستعرض =====
        let alibabaViewerData = {
            isOpen: false,
            currentIndex: 0,
            mediaItems: [],
            product: null,
            isAutoPlaying: false,
            autoPlayInterval: null,
            startX: 0,
            isDragging: false
        };

        function extractYoutubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/shorts\/)([^&\n?#]+)/,
                /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,
                /youtube.com\/shorts\/([a-zA-Z0-9_-]+)/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1] && match[1].length === 11) {
                    return match[1];
                }
                if (match && match[7] && match[7].length === 11) {
                    return match[7];
                }
            }
            
            return null;
        }

        function addNavigationButtons(container) {
            const prevButton = document.createElement('button');
            prevButton.className = 'alibaba-slide-nav prev';
            prevButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            prevButton.onclick = () => changeAlibabaSlide(alibabaViewerData.currentIndex - 1);
            
            const nextButton = document.createElement('button');
            nextButton.className = 'alibaba-slide-nav next';
            nextButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            nextButton.onclick = () => changeAlibabaSlide(alibabaViewerData.currentIndex + 1);
            
            container.appendChild(prevButton);
            container.appendChild(nextButton);
        }

        function openAlibabaViewer(product) {
            alibabaViewerData.product = product;
            alibabaViewerData.currentIndex = 0;
            alibabaViewerData.isOpen = true;
            
            alibabaViewerData.mediaItems = product.mediaItems || [];
            
            const viewer = document.getElementById('alibabaViewer');
            
            document.getElementById('alibabaProductName').textContent = product.name;
            document.getElementById('alibabaProductTitle').textContent = product.name;
            document.getElementById('alibabaProductPrice').textContent = parseInt(product.price).toLocaleString();
            document.getElementById('alibabaProductCode').textContent = `موديل: ST-${Math.floor(Math.random() * 10000)}`;
            document.getElementById('alibabaProductRating').textContent = `4.8 (${Math.floor(Math.random() * 200) + 50} تقييم)`;
            document.getElementById('alibabaProductSold').textContent = `أكثر من ${Math.floor(Math.random() * 500) + 200} قطعة مباعة`;
            
            const container = document.getElementById('alibabaMainImageContainer');
            container.innerHTML = '';
            
            const firstItem = alibabaViewerData.mediaItems[0];
            if (firstItem) {
                if (firstItem.type === 'video') {
                    const video = document.createElement('video');
                    video.src = firstItem.url;
                    video.controls = true;
                    video.autoplay = true;
                    video.muted = true;
                    video.loop = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'contain';
                    container.appendChild(video);
                } else {
                    const img = document.createElement('img');
                    img.src = firstItem.url;
                    img.className = 'alibaba-main-image';
                    img.alt = '';
                    container.appendChild(img);
                    
                    startAlibabaAutoPlay();
                }
            }
            
            addNavigationButtons(container);
            updateThumbnailGallery();
            calculateAlibabaTotal();
            
            viewer.classList.add('active');
        }

        function updateThumbnailGallery() {
            const gallery = document.getElementById('alibabaThumbnailGallery');
            gallery.innerHTML = alibabaViewerData.mediaItems.map((item, index) => `
                <div class="alibaba-thumbnail ${item.type === 'video' ? 'video-thumb' : ''} ${index === alibabaViewerData.currentIndex ? 'active' : ''}" 
                     onclick="changeAlibabaSlide(${index})">
                    ${item.type === 'video' 
                        ? `<video src="${item.url}" muted></video>` 
                        : `<img src="${item.url}" loading="lazy">`
                    }
                </div>
            `).join('');
        }

        function closeAlibabaViewer() {
            document.getElementById('alibabaViewer').classList.remove('active');
            alibabaViewerData.isOpen = false;
            stopAlibabaAutoPlay();
        }

        function changeAlibabaSlide(index) {
            if (index < 0) index = alibabaViewerData.mediaItems.length - 1;
            if (index >= alibabaViewerData.mediaItems.length) index = 0;
            
            alibabaViewerData.currentIndex = index;
            
            const container = document.getElementById('alibabaMainImageContainer');
            const item = alibabaViewerData.mediaItems[index];
            
            container.innerHTML = '';
            
            if (item.type === 'video') {
                const video = document.createElement('video');
                video.src = item.url;
                video.controls = true;
                video.autoplay = true;
                video.muted = true;
                video.loop = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'contain';
                container.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'alibaba-main-image';
                img.alt = '';
                container.appendChild(img);
            }
            
            addNavigationButtons(container);
            updateThumbnailGallery();
        }

        function calculateAlibabaTotal() {
            const meters = parseFloat(document.getElementById('alibabaMetersInput').value) || 1;
            const price = alibabaViewerData.product ? alibabaViewerData.product.price : 0;
            const total = meters * price;
            document.getElementById('alibabaTotalPrice').textContent = total.toLocaleString() + ' د.ع';
        }

        function addFromAlibabaViewer() {
            if (!alibabaViewerData.product) return;
            
            const meters = parseFloat(document.getElementById('alibabaMetersInput').value);
            if (!meters || meters <= 0) {
                alert("الرجاء إدخال عدد الأمتار");
                return;
            }
            
            const totalPrice = meters * alibabaViewerData.product.price;
            
            cart.push({ 
                n: alibabaViewerData.product.name, 
                p: Math.round(totalPrice), 
                img: getWatermarkedUrl(alibabaViewerData.product.img || (alibabaViewerData.product.images && alibabaViewerData.product.images[0]), 'image'),
                length: meters
            });
            
            document.getElementById('globalCartCount').innerText = cart.length; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            
            const cartIcon = document.querySelector('.cart-icon');
            cartIcon.style.transform = 'scale(1.2) rotate(10deg)';
            setTimeout(() => {
                cartIcon.style.transform = '';
            }, 200);
            
            alert("✅ تمت الإضافة للسلة!");
        }

        function checkoutFromAlibabaViewer() {
            closeAlibabaViewer();
            toggleCartModal();
        }

        function startAlibabaAutoPlay() {
            if (alibabaViewerData.mediaItems.length <= 1) return;
            if (alibabaViewerData.isAutoPlaying) return;
            
            alibabaViewerData.isAutoPlaying = true;
            alibabaViewerData.autoPlayInterval = setInterval(() => {
                let nextIndex = alibabaViewerData.currentIndex + 1;
                if (nextIndex >= alibabaViewerData.mediaItems.length) {
                    nextIndex = 0;
                }
                changeAlibabaSlide(nextIndex);
            }, 3000);
        }

        function stopAlibabaAutoPlay() {
            alibabaViewerData.isAutoPlaying = false;
            if (alibabaViewerData.autoPlayInterval) {
                clearInterval(alibabaViewerData.autoPlayInterval);
                alibabaViewerData.autoPlayInterval = null;
            }
        }

        function setupAlibabaViewerEvents() {
            document.getElementById('alibabaMetersInput').addEventListener('input', calculateAlibabaTotal);
            
            const container = document.getElementById('alibabaMainImageContainer');
            container.addEventListener('touchstart', (e) => {
                alibabaViewerData.startX = e.touches[0].clientX;
                alibabaViewerData.isDragging = true;
            });
            
            container.addEventListener('touchmove', (e) => {
                if (!alibabaViewerData.isDragging) return;
                e.preventDefault();
                
                const currentX = e.touches[0].clientX;
                const diff = alibabaViewerData.startX - currentX;
                
                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        changeAlibabaSlide(alibabaViewerData.currentIndex + 1);
                    } else {
                        changeAlibabaSlide(alibabaViewerData.currentIndex - 1);
                    }
                    alibabaViewerData.isDragging = false;
                }
            });
            
            container.addEventListener('touchend', () => {
                alibabaViewerData.isDragging = false;
            });
        }
    </script>
</body>
</html>
