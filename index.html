const firebaseConfig = { 
    apiKey: "AIzaSyD1TENeV6RkWmrYIjV6seGx84VavsM_tvE", 
    authDomain: "shababekcurtain.firebaseapp.com", 
    databaseURL: "https://shababekcurtain-default-rtdb.asia-southeast1.firebasedatabase.app/", 
    projectId: "shababekcurtain" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const CLOUD_NAME = "dnkuwf8q9", UPLOAD_PRESET = "afsx4w9k", LOGO_ID = "shababek_logo";
let cur = null, cart = [], adminClicks = 0;

function v(id) { return document.getElementById(id).value; }

// --- Ù…Ø­Ø±Ùƒ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ---
function getWatermarkedUrl(url) {
    if (!url || !url.includes("cloudinary.com")) return url;
    return url.replace("/upload/", `/upload/l_${LOGO_ID},o_25,w_250,g_center/`);
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ ---
function showPage(id, push = true) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
    if(push) history.pushState({pageId: id}, null, "");
}

function handleLogoClick() { 
    adminClicks++; 
    if(adminClicks >= 5) { if(prompt("Ø§Ù„Ø±Ù…Ø²:") === "8496") showPage('adminPanel'); adminClicks = 0; } 
    else { showPage('homePage'); } 
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ ÙˆØªØµØ­ÙŠØ­Ù‡Ø§) ---
function openCat(n) { 
    db.ref('products').once('value', snap => { 
        const items = Object.values(snap.val() || {}).filter(i => i.category === n); 
        document.getElementById('catTitle').innerText = n; 
        document.getElementById('catGrid').innerHTML = items.map(x => `
            <div style="background:white;border-radius:20px;overflow:hidden;box-shadow:0 8px 15px rgba(0,0,0,0.05);" onclick='openCalc(${JSON.stringify(x)})'>
                <img src="${x.img}" style="width:100%;height:250px;object-fit:cover;">
                <div style="padding:20px;text-align:center;">
                    <h3>${x.name}</h3>
                    <p style="color:var(--gold);font-weight:900;">${parseInt(x.price).toLocaleString()} Ø¯.Ø¹</p>
                </div>
            </div>`).join(''); 
        showPage('categoryView'); 
    }); 
}

function openCalc(p) { 
    cur = p; 
    showPage('productCalculator'); 
    document.getElementById('pName').innerText = p.name; 
    document.getElementById('pPrice').innerText = parseInt(p.price).toLocaleString(); 
    const imgElem = document.getElementById('pImg');
    if(imgElem) imgElem.src = getWatermarkedUrl(p.img); 
    document.getElementById('hIn').value = ""; 
}

// --- Ø¯Ø§Ù„Ø© Ø¯ÙƒØªÙˆØ± Ø¯ÙŠÙƒÙˆØ± (AI) ---
async function handleDrImage(input) {
    if (!input.files || !input.files[0]) return;
    const box = document.getElementById('aiResponse');
    const avatar = document.getElementById('drAvatar');
    const status = document.getElementById('drStatus');
    
    if(avatar) avatar.src = "https://i.ibb.co/ZzMvg7Mz/Disgust-removebg-preview.png";
    status.innerText = "Ø¯ÙƒØªÙˆØ± Ø¯ÙŠÙƒÙˆØ± ÙŠØ­Ù„Ù„ ØºØ±ÙØªÙƒ Ø§Ù„Ø¢Ù†...";
    box.style.display = "block";
    box.innerHTML = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...`;

    try {
        const reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.onload = async (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; 
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH; canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const base64Data = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

                const response = await fetch("https://shababek-ai.bilalmohammedsalem23.workers.dev", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Data })
                });

                const data = await response.json();
                if (data.candidates) {
                    if(avatar) avatar.src = "https://i.ibb.co/q3z1RscN/Neutral-removebg-preview.png";
                    status.innerText = "ÙˆØ¬Ø¯ØªÙ‡Ø§! Ø¥Ù„ÙŠÙƒ Ù†ØµÙŠØ­Ø© Ø¯ÙƒØªÙˆØ± Ø¯ÙŠÙƒÙˆØ±:";
                    box.innerHTML = `<div style="padding:15px; background:white; border-right:5px solid var(--gold);">${data.candidates[0].content.parts[0].text}</div>`;
                }
            };
        };
    } catch (e) { status.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!"; }
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø·ÙˆØ± ---
function addToCart() {
    const h = v('hIn');
    if(!h || h <= 0) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø·ÙˆÙ„ Ø¨Ø§Ù„Ù…ØªØ±");
    
    cart.push({ n: cur.name, p: Math.round(h * cur.price), img: getWatermarkedUrl(cur.img) });
    document.getElementById('globalCartCount').innerText = cart.length;
    
    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©! Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ ğŸ›’");
}

function toggleCartModal() {
    const o = document.getElementById('cartOverlay');
    o.style.display = o.style.display === 'flex' ? 'none' : 'flex';
    
    let total = 0;
    const list = document.getElementById('cartItemsList');
    list.innerHTML = cart.map((i, index) => {
        total += i.p;
        return `
        <div class="cart-item" style="display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid #eee;">
            <img src="${i.img}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
            <div style="flex:1;"><b>${i.n}</b><br><span style="color:var(--gold)">${i.p.toLocaleString()} Ø¯.Ø¹</span></div>
            <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="removeFromCart(${index})"></i>
        </div>`;
    }).join('') || '<p style="text-align:center; padding:20px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>';
    
    if(cart.length > 0) {
        list.innerHTML += `<div style="margin-top:15px; font-weight:900; text-align:center; background:#eee; padding:10px; border-radius:10px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()} Ø¯.Ø¹</div>`;
    }
}

function removeFromCart(idx) { cart.splice(idx, 1); document.getElementById('globalCartCount').innerText = cart.length; toggleCartModal(); }

function sendOrder() {
    if(cart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
    const orderID = "SH-" + Math.floor(1000 + Math.random() * 9000);
    const city = document.getElementById('userCity').value;
    const pay = document.getElementById('userPayment').value;
    let msg = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: *${orderID}*\nğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${city}\nğŸ’° Ø§Ù„Ø¯ÙØ¹: ${pay}\nğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n`;
    cart.forEach((i, x) => msg += `${x+1}- ${i.n}: ${i.p.toLocaleString()} Ø¯.Ø¹\n`);
    
    window.location.href = `https://wa.me/9647883002797?text=${encodeURIComponent(msg)}`;
    
    confetti({particleCount: 200, spread: 70, origin: { y: 0.6 }});
    cart = []; document.getElementById('globalCartCount').innerText = "0"; toggleCartModal();
}

// --- Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
function handleSearch() {
    const q = v('searchInput').toLowerCase();
    const res = document.getElementById('searchRes');
    if(q.length < 2) return res.style.display = 'none';
    db.ref('products').once('value', snap => {
        const found = Object.values(snap.val() || {}).filter(p => p.name.toLowerCase().includes(q));
        res.innerHTML = found.map(p => `<div onclick='openCalc(${JSON.stringify(p)}); document.getElementById("searchRes").style.display="none"' style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;">${p.name}</div>`).join('');
        res.style.display = 'block';
    });
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
db.ref('categories').on('value', snap => {
    const cats = snap.val() || {};
    document.getElementById('categoriesList').innerHTML = Object.values(cats).map(c => `
        <div class="cat-card-new" onclick="openCat('${c.name}')">
            <img src="${c.img}" style="width:100%; height:100%; object-fit:cover;">
            <div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:var(--gold); color:white; padding:10px 25px; border-radius:12px; font-weight:900;">${c.name}</div>
        </div>`).join('');
});
