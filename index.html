<script>
    // الدالة المحدثة لجلب الفيديوهات (Shorts) وتشغيلها تلقائياً
    function openDocSec(name) {
        document.getElementById('docSTitle').innerText = "قسم: " + name;
        db.ref('docTopics').once('value', snap => {
            const topics = Object.entries(snap.val() || {}).filter(([k,v]) => v.section === name);
            
            if (topics.length === 0) {
                document.getElementById('docTopicsList').innerHTML = "<p style='text-align:center; padding:50px; opacity:0.5;'>لا يوجد محتوى حالياً.</p>";
            } else {
                document.getElementById('docTopicsList').innerHTML = topics.map(([k,v]) => {
                    let mediaHtml = '';
                    if (v.type === 'vid') {
                        let videoId = extractYoutubeId(v.media);
                        if (videoId) {
                            // تحويل الرابط لصيغة Embed مع تفعيل التشغيل التلقائي والصمت والتكرار
                            // mute=1 (ضروري للتشغيل التلقائي) | loop=1 (للتكرار مثل الريلز)
                            mediaHtml = `
                                <div class="reel-box" style="position:relative; padding-top: 177.77%; background:#000;">
                                    <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                                        src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0&modestbranding=1&rel=0&iv_load_policy=3" 
                                        frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
                                    </iframe>
                                </div>`;
                        } else {
                            mediaHtml = `<video src="${v.media}" class="reel-video" autoplay muted loop playsinline></video>`;
                        }
                    } else {
                        mediaHtml = `<img src="${v.media}" style="width:100%; border-radius:20px; display:block;">`;
                    }

                    return `
                    <div class="reel-box" style="margin-bottom:30px;">
                        ${mediaHtml}
                        <div style="padding:15px; background:white;">
                            <h3 style="font-weight:900; margin-bottom:10px;">${v.title}</h3>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <i class="fas fa-heart heart-icon" onclick="silentLike('${k}', '${v.title}', this)"></i> 
                                <span style="font-weight:bold;">${v.likes || 0} إعجاب</span>
                            </div>
                            <div style="margin-top:15px; display:flex; gap:5px;">
                                <input type="text" id="in-${k}" placeholder="اكتب تعليقك هنا..." style="flex:1; padding:10px; border-radius:10px; border:1px solid #eee;">
                                <button onclick="silentComment('${k}','${v.title}')" style="background:var(--gold); border:none; color:white; padding:10px 15px; border-radius:10px; font-weight:900; cursor:pointer;">إرسال</button>
                            </div>
                            <div id="comm-${k}" style="font-size:0.85rem; margin-top:12px; color:#555; background:#fcfcfc; padding:10px; border-radius:8px;"></div>
                        </div>
                    </div>`;
                }).join('');
            }
            topics.forEach(([k,v]) => loadComments(k));
            showPage('docInside');
        });
    }

    // دالة استخراج الـ ID من روابط يوتيوب (تدعم Shorts والعادية)
    function extractYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|shorts\/)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
</script>
