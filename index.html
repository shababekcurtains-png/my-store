<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>شبابيك للستائر - Shababek Curtains</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/3y1ZNCk0/1.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" preload>
    
    <!-- Preload for critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="preload" href="https://res.cloudinary.com/dnkuwf8q9/video/upload/v1772027160/gemini_generated_video_077d6d04_ehg756.mp4" as="video">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --gold: #d9b382; --brown: #3d2e24; --bg: #f9f6f2; --white: #ffffff; --whatsapp: #25D366; --red: #ff4d4d; --teal: #2A9D8F; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* تحسين أداء الجوال */
        html {
            -webkit-text-size-adjust: 100%;
        }
        
        body { 
            background: var(--white); 
            color: var(--brown); 
            overflow-x: hidden; 
            scroll-behavior: smooth; 
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
        }

        /* تحسين اللمس للجوال */
        button, a, .cat-card-new, .cart-icon, .search-box, .ai-camera-btn {
            touch-action: manipulation;
        }

        .top-banner { background: var(--brown); color: white; padding: 10px 5%; text-align: center; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .wa-link { color: var(--whatsapp); text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        header { background: var(--white); padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo-center { flex: 1; display: flex; justify-content: center; cursor: pointer; }
        .logo-img { height: 90px; transition: 0.3s; }
        
        .header-left { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
        .cart-icon { position: relative; cursor: pointer; font-size: 2.2rem; color: var(--brown); background: white; padding: 5px; border-radius: 12px; transition: 0.3s; border: 1px solid #eee; }
        .cart-count { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; font-size: 0.85rem; padding: 2px 8px; border-radius: 50%; font-weight: 900; }
        
        /* تحسين البحث مع زر الكاميرا */
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-box { 
            position: relative; 
            width: 40px; 
            height: 40px; 
            transition: 0.4s; 
            overflow: hidden; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
        }
        
        .search-box:hover, .search-box:focus-within { 
            width: 250px; 
            border-color: var(--gold); 
        }
        
        .search-box input { 
            border: none; 
            outline: none; 
            background: transparent; 
            padding: 10px; 
            width: 210px; 
            font-size: 0.9rem; 
        }
        
        .search-box i { 
            padding: 10px; 
            color: var(--brown); 
            cursor: pointer; 
        }
        
        /* زر الكاميرا الجديد */
        .ai-camera-btn {
            background: var(--teal);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .ai-camera-btn:hover {
            background: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #searchSuggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        #searchSuggestions div {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            transition: 0.3s;
            border-bottom: 1px solid #eee;
        }
        
        #searchSuggestions div:hover {
            background: var(--bg);
        }
        
        #searchSuggestions img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        #searchSuggestions span {
            flex: 1;
            font-weight: 600;
        }
        
        #searchSuggestions small {
            color: var(--gold);
            font-size: 0.8rem;
        }

        /* ===== نافذة الكاميرا والذكاء الاصطناعي ===== */
        .ai-camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 20000;
            justify-content: center;
            align-items: center;
        }
        
        .ai-camera-modal.active {
            display: flex;
        }
        
        .ai-camera-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 30px;
            padding: 25px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .ai-camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .ai-camera-header h2 {
            font-weight: 900;
            color: var(--brown);
            font-size: 1.4rem;
        }
        
        .ai-camera-close {
            background: var(--red);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ai-camera-close:hover {
            transform: scale(1.1);
        }
        
        .camera-preview {
            width: 100%;
            height: 300px;
            background: #f0f0f0;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .camera-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .camera-btn.capture {
            background: var(--teal);
            color: white;
        }
        
        .camera-btn.upload {
            background: var(--gold);
            color: white;
        }
        
        .camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .ai-analysis-status {
            background: var(--bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        .ai-analysis-status.active {
            display: block;
        }
        
        .ai-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        .ai-recommendations {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .ai-recommendations.active {
            display: grid;
        }
        
        .ai-recommendation-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        
        .ai-recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .ai-recommendation-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .ai-recommendation-card .info {
            padding: 10px;
        }
        
        .ai-recommendation-card h4 {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        
        .ai-recommendation-card .price {
            color: var(--gold);
            font-weight: 900;
            font-size: 0.9rem;
        }
        
        .ai-recommendation-card .match-badge {
            background: var(--teal);
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            display: inline-block;
            margin-top: 5px;
        }

        /* شريط التنقل الرئيسي */
        .nav-bar { 
            background: #fcfcfc; 
            border-bottom: 1px solid #eee; 
            padding: 12px 0; 
            overflow-x: auto; 
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
        }
        .nav-menu { 
            display: inline-flex; 
            gap: 25px; 
            list-style: none; 
            padding: 0 20px; 
        }
        .nav-menu a { 
            text-decoration: none; 
            color: var(--brown); 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: 0.3s; 
        }
        .nav-menu a:hover { 
            color: var(--gold); 
        }
        .nav-menu a.active { 
            color: var(--gold); 
        }

        .page { display: none; width: 100%; animation: fadeIn 0.4s ease; }
        .active { display: block !important; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* تأثيرات حركية للبطاقات */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cat-card-new {
            animation: fadeInUp 0.5s ease;
            animation-fill-mode: both;
        }
        
        .cat-card-new:nth-child(1) { animation-delay: 0.1s; }
        .cat-card-new:nth-child(2) { animation-delay: 0.15s; }
        .cat-card-new:nth-child(3) { animation-delay: 0.2s; }
        .cat-card-new:nth-child(4) { animation-delay: 0.25s; }
        .cat-card-new:nth-child(5) { animation-delay: 0.3s; }
        .cat-card-new:nth-child(6) { animation-delay: 0.35s; }
        .cat-card-new:nth-child(7) { animation-delay: 0.4s; }
        .cat-card-new:nth-child(8) { animation-delay: 0.45s; }
        .cat-card-new:nth-child(9) { animation-delay: 0.5s; }
        .cat-card-new:nth-child(10) { animation-delay: 0.55s; }

        #cartOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .cart-modal { background: var(--white); width: 90%; max-width: 500px; border-radius: 30px; padding: 35px; position: relative; max-height: 90vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; }

        /* ===== قسم الهيرو ===== */
        .hero {
            height: 70vh;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .hero-video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .hero-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        .hero-video::-webkit-media-controls {
            display: none !important;
        }

        .hero-video::-webkit-media-controls-start-playback-button {
            display: none !important;
        }

        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 20px;
        }

        .hero h1 { 
            font-size: clamp(1.8rem, 5vw, 3.5rem); 
            font-weight: 900; 
            margin-bottom: 25px; 
            text-shadow: 0 2px 15px rgba(0,0,0,0.5);
            animation: fadeInUp 1s ease;
        }

        .hero-btns { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            width: 100%; 
            max-width: 320px; 
            margin-bottom: 30px; 
        }

        .btn-gold { 
            background: var(--gold); 
            color: white; 
            border: none; 
            padding: 16px 35px; 
            border-radius: 12px; 
            font-weight: 900; 
            cursor: pointer; 
            font-size: 1.1rem; 
            transition: 0.3s; 
        }

        .btn-gold:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn-trans { 
            background: transparent; 
            color: white; 
            border: 2px solid white; 
            padding: 16px 35px; 
            border-radius: 12px; 
            font-weight: 900; 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            transition: 0.3s; 
            backdrop-filter: blur(5px);
        }

        .btn-trans:hover {
            background: var(--gold);
            border-color: var(--gold);
            transform: translateY(-3px);
        }

        .social-hero { 
            display: flex; 
            gap: 20px; 
            animation: fadeInUp 1s ease 0.3s both;
        }

        .social-hero a { 
            color: var(--white); 
            font-size: 1.8rem; 
            transition: 0.4s; 
        }

        .social-hero a:hover { 
            color: var(--gold); 
            transform: translateY(-8px) scale(1.2); 
        }

        .features-section { background: var(--bg); padding: 50px 5%; text-align: center; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; max-width: 1200px; margin: auto; }
        .f-card { background: white; padding: 25px 15px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); transition: 0.3s; }
        .f-card:hover { transform: translateY(-5px); border: 1px solid var(--gold); }

        /* ===== التوصيات ===== */
        .recommendations {
            padding: 40px 5%;
            background: var(--bg);
        }
        
        .recommendations h3 {
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--brown);
            font-size: 1.3rem;
        }
        
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .recommendations-grid div {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .recommendations-grid div:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .recommendations-grid img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .recommendations-grid h4 {
            padding: 10px 10px 5px;
            font-size: 0.95rem;
        }
        
        .recommendations-grid p {
            padding: 0 10px 10px;
            color: var(--gold);
            font-weight: 700;
        }

        .stat-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .stat-card { background: #f4f1ed; padding: 25px; border-radius: 20px; text-align: center; }
        .stat-num { font-size: 2.2rem; font-weight: 900; color: var(--gold); display: block; }

        .footer-cta { background: var(--brown); color: white; padding: 40px 5%; text-align: center; border-radius: 40px 40px 0 0; }
        .footer-cta h2 { font-size: 1.6rem; font-weight: 900; margin-bottom: 10px; }
        .btn-footer-wa { background: transparent; border: 1px solid rgba(255,255,255,0.4); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; margin: 5px; font-weight: 600; font-size: 0.9rem; }
        .btn-footer-prod { background: var(--gold); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; margin: 5px; font-weight: 600; font-size: 0.9rem; }

        .admin-box { background: #f4f4f4; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: right; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 10px; overflow: hidden; font-size: 0.85rem; table-layout: fixed; }
        .admin-table td { padding: 10px; border-bottom: 1px solid #eee; word-wrap: break-word; }
        .admin-table img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; font-family: 'Cairo'; }

        footer { background: var(--brown); color: rgba(255,255,255,0.6); padding: 20px 5%; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
        
        #searchRes { position: absolute; top: 110px; left: 5%; width: 90%; background: white; z-index: 5000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 20px; padding: 15px; display: none; max-height: 400px; overflow-y: auto; }
        
        /* تنسيق أقسام المنتجات */
        #categoriesList {
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important; 
            gap: 15px;
            padding: 20px 5%;
        }

        .cat-card-new {
            position: relative;
            height: 350px;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        
        .cat-card-new:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .cat-card-new img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }
        
        .cat-card-new:hover img {
            transform: scale(1.1);
        }
        
        .cat-card-new > div:last-child {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gold);
            color: white;
            padding: 10px 25px;
            border-radius: 12px;
            font-weight: 900;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            #categoriesList {
                display: flex !important;
                grid-template-columns: none !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory;
                gap: 15px;
                padding: 20px;
                -webkit-overflow-scrolling: touch;
            }
            
            #categoriesList .cat-card-new {
                flex: 0 0 250px !important;
                height: 300px;
                scroll-snap-align: start;
            }
            
            .recommendations-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .camera-controls {
                flex-direction: column;
            }
        }

        /* تنسيق شبكة المنتجات */
        #catGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 25px;
            padding: 20px 5%;
        }
        
        /* تنسيق طرق الدفع مثل المنتدى */
        #paymentList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .payment-card {
            position: relative;
            height: 400px;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
            background: white;
            transition: 0.4s;
        }
        
        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
        }
        
        .payment-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 30px;
            display: block;
        }
        
        .payment-card .payment-overlay {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: var(--gold);
            color: white;
            padding: 8px 5px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            font-weight: 900;
            font-size: 1rem;
        }
        
        @media (max-width: 768px) {
            #paymentList {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            .payment-card {
                height: 320px;
            }
        }

        /* مؤشر التحميل */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== مستعرض المنتجات بنظام Alibaba ===== */
        .alibaba-viewer-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .alibaba-viewer-container.active {
            display: flex;
            opacity: 1;
        }
        
        .alibaba-viewer-content {
            width: 100vw;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .alibaba-viewer-header {
            background: var(--brown);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--gold);
            height: 60px;
            flex-shrink: 0;
        }
        
        .alibaba-viewer-header h2 {
            font-size: 1.2rem;
            font-weight: 900;
            margin: 0;
        }
        
        .alibaba-viewer-header .product-code {
            color: var(--gold);
            font-size: 0.8rem;
        }
        
        .alibaba-viewer-close {
            background: var(--gold);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .alibaba-viewer-close:hover {
            transform: rotate(90deg);
            background: var(--brown);
        }
        
        .alibaba-viewer-body {
            display: flex;
            flex: 1;
            min-height: 0;
            height: calc(100vh - 60px);
            overflow: hidden;
            background: #f8f8f8;
        }
        
        .alibaba-viewer-media {
            flex: 1.5;
            padding: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .alibaba-main-image-container {
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid #eee;
            position: relative;
            height: calc(100% - 100px);
            min-height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .alibaba-main-image-container iframe,
        .alibaba-main-image-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        .alibaba-main-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        .alibaba-thumbnail-gallery {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: thin;
            height: 80px;
            flex-shrink: 0;
        }
        
        .alibaba-thumbnail {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.3s;
            flex-shrink: 0;
            background: #f0f0f0;
        }
        
        .alibaba-thumbnail:hover {
            transform: translateY(-3px);
        }
        
        .alibaba-thumbnail.active {
            border-color: var(--gold);
            box-shadow: 0 5px 15px rgba(217, 179, 130, 0.3);
        }
        
        .alibaba-thumbnail img,
        .alibaba-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .alibaba-thumbnail.video-thumb {
            position: relative;
        }
        
        .alibaba-thumbnail.video-thumb::after {
            content: '▶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.5);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .alibaba-slide-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gold);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: 0.3s;
            opacity: 0.8;
        }
        
        .alibaba-slide-nav:hover {
            opacity: 1;
            background: var(--brown);
            transform: translateY(-50%) scale(1.1);
        }
        
        .alibaba-slide-nav.prev {
            left: 10px;
        }
        
        .alibaba-slide-nav.next {
            right: 10px;
        }
        
        .alibaba-viewer-info {
            flex: 1;
            padding: 20px;
            background: white;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow-y: auto;
        }
        
        .alibaba-product-title {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--brown);
            line-height: 1.2;
        }
        
        .alibaba-product-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .alibaba-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 0.85rem;
        }
        
        .alibaba-meta-item i {
            color: var(--gold);
        }
        
        .alibaba-price-section {
            background: #faf5f0;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #f0e0d0;
        }
        
        .alibaba-price-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .alibaba-price {
            font-size: 2rem;
            font-weight: 900;
            color: var(--gold);
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        
        .alibaba-price-unit {
            font-size: 0.9rem;
            color: #999;
            font-weight: normal;
        }
        
        .alibaba-meters-section {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .alibaba-meters-label {
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--brown);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }
        
        .alibaba-meters-label i {
            color: var(--gold);
            font-size: 1.1rem;
        }
        
        .alibaba-meters-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .alibaba-meters-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Cairo', sans-serif;
            transition: 0.3s;
        }
        
        .alibaba-meters-input:focus {
            border-color: var(--gold);
            outline: none;
            box-shadow: 0 0 0 3px rgba(217, 179, 130, 0.2);
        }
        
        .alibaba-meters-unit {
            font-size: 1rem;
            color: #666;
            font-weight: 900;
        }
        
        .alibaba-total-price {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alibaba-total-label {
            font-weight: 900;
            color: var(--brown);
            font-size: 0.95rem;
        }
        
        .alibaba-total-value {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--gold);
        }
        
        .alibaba-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .alibaba-add-to-cart-btn {
            background: var(--gold);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .alibaba-add-to-cart-btn:hover {
            background: var(--brown);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .alibaba-checkout-btn {
            background: white;
            color: var(--brown);
            border: 2px solid var(--gold);
            padding: 15px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .alibaba-checkout-btn:hover {
            background: var(--gold);
            color: white;
        }
        
        @media (max-width: 768px) {
            .alibaba-viewer-body {
                flex-direction: column;
            }
            
            .alibaba-main-image-container {
                height: 300px;
            }
            
            .alibaba-product-title {
                font-size: 1.2rem;
            }
            
            .alibaba-viewer-header h2 {
                font-size: 1rem;
            }
            
            .alibaba-slide-nav {
                width: 35px;
                height: 35px;
            }
            
            .alibaba-thumbnail {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>

    <div class="top-banner">
        <span>شبابيك للستائر - ظل وذوق</span>
        <a href="https://wa.me/9647883002797" class="wa-link"><i class="fab fa-whatsapp"></i> تواصل عبر الواتساب</a>
    </div>

    <header>
        <div style="font-weight:900; line-height:1; flex:1;">شبابيك<br><span style="color:var(--gold); font-size:1rem;">للستائر</span></div>
        <div class="logo-center" onclick="handleLogoClick()"><img src="https://i.ibb.co/3y1ZNCk0/1.png" class="logo-img"></div>
        <div class="header-left">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search" onclick="handleSmartSearch()"></i>
                    <input type="text" id="searchInput" placeholder="ابحث عن موديل.." onkeyup="debounce(handleSmartSearch, 300)()">
                </div>
                <div class="ai-camera-btn" onclick="openAICamera()">
                    <i class="fas fa-camera"></i>
                </div>
                <div id="searchSuggestions"></div>
            </div>
            <div class="cart-icon" onclick="toggleCartModal()">
                <i class="fas fa-shopping-basket"></i>
                <span id="globalCartCount" class="cart-count">0</span>
            </div>
        </div>
    </header>
    
    <!-- شريط التنقل الرئيسي -->
    <div class="nav-bar">
        <ul class="nav-menu">
            <li><a onclick="showPage('homePage')">الرئيسية</a></li>
            <li><a onclick="showPage('homePage'); setTimeout(() => { document.getElementById('categories').scrollIntoView({behavior: 'smooth'}); }, 100);">المنتجات</a></li>
            <li><a href="ai.html">منتدى شبابيك</a></li>
            <li><a onclick="showPage('paymentPage')">طرق الدفع</a></li>
            <li><a onclick="showPage('aboutPage')">من نحن</a></li>
            <li><a onclick="showPage('contactPage')">تواصل معنا</a></li>
        </ul>
    </div>
    
    <!-- نافذة الكاميرا والذكاء الاصطناعي -->
    <div class="ai-camera-modal" id="aiCameraModal">
        <div class="ai-camera-content">
            <div class="ai-camera-header">
                <h2><i class="fas fa-robot"></i> دكتور ستائر الذكي</h2>
                <button class="ai-camera-close" onclick="closeAICamera()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="camera-preview" id="cameraPreview">
                <video id="cameraStream" autoplay playsinline></video>
                <img id="capturedImage" style="display: none;">
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn capture" onclick="captureImage()">
                    <i class="fas fa-camera"></i> التقط صورة
                </button>
                <button class="camera-btn upload" onclick="uploadImage()">
                    <i class="fas fa-cloud-upload-alt"></i> ارفع صورة
                </button>
                <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
            </div>
            
            <div class="ai-analysis-status" id="aiAnalysisStatus">
                <p>جاري تحليل الصورة باستخدام الذكاء الاصطناعي...</p>
                <div class="ai-spinner"></div>
            </div>
            
            <div class="ai-recommendations" id="aiRecommendations"></div>
        </div>
    </div>

    <div id="cartOverlay" onclick="if(event.target===this) toggleCartModal()">
        <div class="cart-modal">
            <h2 style="margin-bottom:20px; border-bottom:2px solid var(--gold); padding-bottom:10px; font-weight:900;">سلة المشتريات</h2>
            <div id="cartItemsList"></div>
            
            <div id="checkoutFields" style="margin-top:20px; border-top:2px solid var(--gold); padding-top:15px;">
                <label style="font-weight:bold; font-size:0.9rem;">المحافظة:</label>
                <select id="userCity">
                    <option value="بغداد">بغداد</option><option value="البصرة">البصرة</option><option value="نينوى">نينوى</option><option value="أربيل">أربيل</option><option value="النجف">النجف</option><option value="كربلاء">كربلاء</option><option value="بابل">بابل</option><option value="الأنبار">الأنبار</option><option value="ذي قار">ذي قار</option><option value="ديالى">ديالى</option><option value="ميسان">ميسان</option><option value="واسط">واسط</option><option value="المثنى">المثنى</option><option value="كركوك">كركوك</option><option value="صلاح الدين">صلاح الدين</option><option value="دهوك">دهوك</option><option value="السليمانية">السليمانية</option><option value="القادسية">القادسية</option>
                </select>

                <label style="font-weight:bold; font-size:0.9rem; margin-top:10px; display:block;">هل تحتاج خدمة تركيب؟</label>
                <select id="userInstall">
                    <option value="بدون تركيب">لا، بدون تركيب</option>
                    <option value="مع التركيب">نعم، أحتاج تركيب</option>
                </select>

                <label style="font-weight:bold; font-size:0.9rem; margin-top:10px; display:block;">طريقة الدفع:</label>
                <select id="userPayment"></select>
            </div>

            <div style="margin-top:20px;">
                <button class="btn-gold" style="width:100%; padding:20px;" onclick="sendOrder()">إرسال الطلب عبر واتساب</button>
                <p onclick="toggleCartModal()" style="margin-top:20px; text-align:center; color:#999; cursor:pointer; font-weight:bold;">إغلاق</p>
            </div>
        </div>
    </div>

    <!-- مستعرض المنتجات بنظام Alibaba -->
    <div class="alibaba-viewer-container" id="alibabaViewer" onclick="if(event.target===this) closeAlibabaViewer()">
        <div class="alibaba-viewer-content">
            <div class="alibaba-viewer-header">
                <div>
                    <h2 id="alibabaProductName">اسم المنتج</h2>
                    <span class="product-code" id="alibabaProductCode">موديل: ST-2024</span>
                </div>
                <button class="alibaba-viewer-close" onclick="closeAlibabaViewer()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="alibaba-viewer-body">
                <div class="alibaba-viewer-media">
                    <div class="alibaba-main-image-container" id="alibabaMainImageContainer"></div>
                    <div class="alibaba-thumbnail-gallery" id="alibabaThumbnailGallery"></div>
                </div>
                
                <div class="alibaba-viewer-info">
                    <h1 class="alibaba-product-title" id="alibabaProductTitle">اسم المنتج</h1>
                    
                    <div class="alibaba-product-meta">
                        <div class="alibaba-meta-item">
                            <i class="fas fa-star"></i>
                            <span id="alibabaProductRating">4.8 (128 تقييم)</span>
                        </div>
                        <div class="alibaba-meta-item">
                            <i class="fas fa-shopping-bag"></i>
                            <span id="alibabaProductSold">أكثر من 500 قطعة مباعة</span>
                        </div>
                    </div>
                    
                    <div class="alibaba-price-section">
                        <div class="alibaba-price-label">سعر المتر</div>
                        <div class="alibaba-price">
                            <span id="alibabaProductPrice">0</span>
                            <span class="alibaba-price-unit">د.ع</span>
                        </div>
                    </div>
                    
                    <div class="alibaba-meters-section">
                        <div class="alibaba-meters-label">
                            <i class="fas fa-ruler"></i>
                            أدخل عدد الأمتار المطلوبة
                        </div>
                        <div class="alibaba-meters-input-group">
                            <input type="number" id="alibabaMetersInput" class="alibaba-meters-input" 
                                   placeholder="مثلاً: 5" min="0.5" step="0.5" value="1">
                            <span class="alibaba-meters-unit">متر</span>
                        </div>
                        <div class="alibaba-total-price">
                            <span class="alibaba-total-label">الإجمالي:</span>
                            <span class="alibaba-total-value" id="alibabaTotalPrice">0 د.ع</span>
                        </div>
                    </div>
                    
                    <div class="alibaba-action-buttons">
                        <button class="alibaba-add-to-cart-btn" onclick="addFromAlibabaViewer()">
                            <i class="fas fa-cart-plus"></i>
                            إضافة إلى السلة
                        </button>
                        <button class="alibaba-checkout-btn" onclick="checkoutFromAlibabaViewer()">
                            <i class="fas fa-credit-card"></i>
                            إتمام الطلب
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- التوصيات -->
    <div id="recommendations" class="recommendations" style="display: none;"></div>

    <main id="mainContainer">
        <div id="homePage" class="page active">
            <!-- قسم الهيرو -->
            <section class="hero">
                <div class="hero-video-container">
                    <video class="hero-video" autoplay loop muted playsinline webkit-playsinline>
                        <source src="https://res.cloudinary.com/dnkuwf8q9/video/upload/v1772027160/gemini_generated_video_077d6d04_ehg756.mp4" type="video/mp4">
                    </video>
                    <div class="hero-overlay"></div>
                    
                    <div class="hero-content">
                        <h1>فخامة التفاصيل تبدأ من شبابيك منزلك</h1>
                        <div class="hero-btns">
                            <button onclick="document.getElementById('categories').scrollIntoView({behavior: 'smooth'})" class="btn-gold">احسب سعر ستائرك الآن</button>
                            <a href="https://wa.me/9647883002797" class="btn-trans"><i class="fab fa-whatsapp"></i> استشارة مجانية</a>
                        </div>
                        <div class="social-hero">
                            <a href="https://www.facebook.com/profile.php?id=61587692021311" target="_blank"><i class="fab fa-facebook"></i></a>
                            <a href="https://www.instagram.com/shababek.curtains/" target="_blank"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.tiktok.com/@shababek.curtains" target="_blank"><i class="fab fa-tiktok"></i></a>
                            <a href="https://youtube.com/@shababek.curtains?si=KKsEbL98N0fq2e2U" target="_blank"><i class="fab fa-youtube"></i></a>
                            <a href="https://x.com/ShababekCurtain" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
                            <a href="https://www.snapchat.com/add/shababekcurtin?share_id=B2Prmbx5_Xo&locale=en-IQ" target="_blank"><i class="fab fa-snapchat"></i></a>
                        </div>
                    </div>
                </div>
            </section>

            <section id="categories" style="padding: 40px 0;">
                <h2 style="text-align:center; font-weight:900; margin-bottom:15px;">أقسامنا المميزة</h2>
                <div id="categoriesList"></div>
            </section>
            <section class="features-section">
                <h2 style="margin-bottom:35px; font-weight:900;">لماذا شبابيك؟</h2>
                <div class="features-grid">
                    <div class="f-card"><i class="fa-solid fa-shield-halved" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>ضمان حقيقي</h3><p>أرقى الأقمشة بضمان رسمي.</p></div>
                    <div class="f-card"><i class="fa-solid fa-truck-fast" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>قياس منزلي</h3><p>نصلكم للقياس مجاناً.</p></div>
                    <div class="f-card"><i class="fa-solid fa-ruler-combined" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>تفصيل دقيق</h3><p>خياطة احترافية حسب الطلب.</p></div>
                    <div class="f-card"><i class="fa-solid fa-palette" style="color:var(--gold); font-size:2.2rem; margin-bottom:10px;"></i><h3>ذوق رفيع</h3><p>أحدث الموديلات العصرية.</p></div>
                </div>
            </section>
        </div>

        <div id="adminPanel" class="page">
            <div style="padding: 40px 5%; max-width: 900px; margin: auto;">
                <h2 style="text-align:center; margin-bottom:40px; font-weight:900;">لوحة الإدارة السحابية</h2>
                <div class="admin-box">
                    <h3>١. إدارة الأقسام</h3>
                    <input type="text" id="admCatName" placeholder="اسم القسم">
                    <input type="file" id="admCatFile" accept="image/*" style="margin: 10px 0; width: 100%;">
                    <button onclick="publishCat()" class="btn-gold">حفظ القسم</button>
                    <table class="admin-table"><tbody id="admListCats"></tbody></table>
                </div>
                <div class="admin-box">
                    <h3>٢. إدارة المنتجات - صور وفيديوهات متعددة</h3>
                    <select id="admProdCatSelect"></select>
                    <input type="text" id="admProdName" placeholder="اسم الموديل">
                    <input type="number" id="admProdPrice" placeholder="السعر">
                    
                    <div style="margin: 15px 0; padding: 15px; background: #eee; border-radius: 10px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                            <i class="fas fa-images"></i> صور المنتج (يمكنك اختيار عدة صور)
                        </label>
                        <input type="file" id="admProdImages" accept="image/*" multiple style="margin: 10px 0; width: 100%;">
                        <small style="color: #666;">يمكنك اختيار أكثر من صورة بالضغط على Ctrl أو Shift</small>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 15px; background: #eee; border-radius: 10px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                            <i class="fas fa-video"></i> روابط فيديوهات متعددة (يوتيوب أو Cloudinary)
                        </label>
                        <div id="videoInputsContainer">
                            <div class="video-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="url" class="admProdVideo" placeholder="رابط فيديو 1">
                                <button type="button" onclick="addVideoInput()" style="background: var(--gold); color: white; border: none; width: 40px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <small style="color: #666;">✅ روابط Cloudinary تحصل على علامة مائية تلقائياً</small>
                    </div>
                    
                    <button onclick="publishProd()" class="btn-gold">نشر المنتج</button>
                    <table class="admin-table"><tbody id="admListProds"></tbody></table>
                </div>
                <div class="admin-box">
                    <h3>٣. إدارة طرق الدفع</h3>
                    <input type="text" id="admPayName" placeholder="اسم الطريقة">
                    <input type="file" id="admPayFile" accept="image/*" style="margin: 10px 0; width: 100%;">
                    <button onclick="publishPayment()" class="btn-gold">حفظ طريقة الدفع</button>
                    <table class="admin-table"><tbody id="admListPays"></tbody></table>
                </div>
            </div>
        </div>

        <div id="aboutPage" class="page">
            <div style="padding: 60px 5%; max-width: 1100px; margin: auto;">
                <h2 style="font-weight:900; font-size:2.5rem; margin-bottom:30px; text-align:center;">شبابيك للستائر</h2>
                <p style="font-size:1.2rem; line-height:2.2; color:#444; text-align:justify;">تأسست شبابيك للستائر بهدف تقديم أفخم وأجود أنواع الستائر المنزلية في العراق. نؤمن بأن الستائر ليست مجرد قطعة قماش، بل هي عنصر أساسي في تصميم المنزل يعكس ذوق أصحابه ويضيف لمسة من الأناقة والفخامة. نقدم مجموعة واسعة من الستائر تشمل البلاك أوت والشفافة والديكورية وستائر الرول، بأقمشة مستوردة من أفضل المصانع العالمية. كما نوفر خدمة التفصيل حسب المقاسات وخدمة التركيب المنزلي بأيدي فنيين متخصصين. رؤيتنا هي أن نكون الوجهة الأولى للستائر الفاخرة في العراق، ونسعى دائماً لتحقيق رضا عملائنا من خلال الجودة العالية والأسعار المنافسة والخدمة المتميزة.</p>
                <div class="stat-grid">
                    <div class="stat-card"><span class="stat-num">500+</span><p>عميل سعيد</p></div>
                    <div class="stat-card"><span class="stat-num">50+</span><p>تصميم حصري</p></div>
                    <div class="stat-card"><span class="stat-num">10+</span><p>سنوات خبرة</p></div>
                </div>
            </div>
        </div>
        
        <div id="contactPage" class="page">
            <div style="padding: 60px 5%; text-align: center; background: var(--bg); border-radius: 40px; margin: 40px 5%;">
                <h2 style="margin-bottom:30px; font-weight: 900; font-size: 2.2rem;">تواصل معنا</h2>
                <div><i class="fa-solid fa-phone"></i> 07883002797</div>
                <div style="margin-top:10px;"><i class="fa-solid fa-location-dot"></i> العراق - بغداد</div>
                <a href="https://wa.me/9647883002797" class="btn-gold" style="display:inline-block; text-decoration:none; margin-top:20px;">مراسلة واتساب مباشر</a>
            </div>
        </div>
        
        <div id="categoryView" class="page">
            <h2 id="catTitle" style="text-align:center; padding:40px 0; font-weight:900;"></h2>
            <div id="catGrid"></div>
        </div>
        
        <div id="productCalculator" class="page">
            <div style="padding:40px 5%; max-width:650px; margin:auto; text-align:center;">
                <img id="pImg" src="" style="width:100%; border-radius:25px; margin-bottom:25px;">
                <h2 id="pName"></h2>
                <div style="color:var(--gold); font-size:1.8rem; font-weight:900; margin-bottom:30px;"><span id="pPrice"></span> د.ع / متر</div>
                <input type="number" id="hIn" placeholder="أدخل الطول بالمتر" min="0.5" step="0.5" style="text-align:center;">
                <button onclick="addToCart()" class="btn-gold" style="width:100%;">إضافة للسلة</button>
                <button onclick="toggleCartModal()" style="background:transparent; border:2px solid var(--gold); color:var(--gold); width:100%; padding:18px; border-radius:12px; margin-top:10px;">إتمام الطلب الآن</button>
            </div>
        </div>
        
        <div id="paymentPage" class="page">
            <div style="padding: 40px 5%; text-align: center;">
                <h2 style="font-weight:900; margin-bottom:30px;">طرق الدفع الآمنة</h2>
                <div id="paymentList"></div>
            </div>
        </div>
    </main>

    <div class="footer-cta">
        <h2>جاهز لتجديد ستائر منزلك؟</h2>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
            <a href="https://wa.me/9647883002797" class="btn-footer-wa">تواصل عبر واتساب</a>
            <a onclick="showPage('homePage'); document.getElementById('categories').scrollIntoView({behavior: 'smooth'})" class="btn-footer-prod">تصفح المنتجات</a>
        </div>
    </div>

    <footer>
        <div style="font-size:1.8rem; font-weight:900; color:var(--gold); margin-bottom:10px;">شبابيك</div>
        <p>© 2026 جميع الحقوق محفوظة لشبابيك للستائر - ظل وذوق</p>
    </footer>

    <script>
        // تهيئة Firebase
        const firebaseConfig = { 
            apiKey: "AIzaSyD1TENeV6RkWmrYIjV6seGx84VavsM_tvE", 
            authDomain: "shababekcurtain.firebaseapp.com", 
            databaseURL: "https://shababekcurtain-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            projectId: "shababekcurtain" 
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // مفتاح Gemini API
        const GEMINI_API_KEY = "AIzaSyBQzcGsFRGcWKThXP4WKDYlAm2KCXuWO28";

        // متغيرات عامة
        const CLOUD_NAME = "dnkuwf8q9";
        const UPLOAD_PRESET = "afsx4w9k";
        const LOGO_ID = "shababek_logo";
        let currentProduct = null;
        let cart = JSON.parse(localStorage.getItem('shababek_cart')) || [];
        let adminClicks = 0;
        let clickTimer;
        let cameraStream = null;
        
        // نظام التخزين المؤقت (Cache)
        let cache = {
            categories: null,
            products: null,
            payments: null,
            lastFetch: 0
        };

        // دالة منع التنفيذ المتكرر (Debounce)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // دالة جلب البيانات مع التخزين المؤقت
        async function getCachedData(ref) {
            const now = Date.now();
            // تحديث كل 5 دقائق فقط
            if (cache[ref] && (now - cache.lastFetch) < 300000) {
                return cache[ref];
            }
            
            const snapshot = await db.ref(ref).once('value');
            cache[ref] = snapshot.val();
            cache.lastFetch = now;
            return cache[ref];
        }

        function getValue(id) { 
            const el = document.getElementById(id);
            return el ? el.value : ""; 
        }

        function showPage(pageId, pushToHistory = true) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                window.scrollTo(0, 0);
                
                if (pushToHistory) {
                    history.pushState({ page: pageId }, '', `#${pageId}`);
                }
            }
        }

        function handleLogoClick() {
            adminClicks++;
            clearTimeout(clickTimer);
            
            if (adminClicks >= 5) {
                adminClicks = 0;
                const pass = prompt("أدخل رمز الدخول السحابي لشبابيك:");
                if (pass === "8496") {
                    showPage('adminPanel');
                    if (typeof confetti === 'function') {
                        confetti({ particleCount: 100, spread: 70 });
                    }
                } else if (pass !== null) { 
                    alert("الرمز غير صحيح!"); 
                }
                return;
            }
            
            clickTimer = setTimeout(() => {
                if (adminClicks === 1) showPage('homePage');
                adminClicks = 0;
            }, 400);
        }

        async function uploadImage(file) {
            if (!file) return "";
            
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { 
                    method: "POST", 
                    body: formData 
                });
                const data = await res.json();
                return data.secure_url;
            } catch (error) {
                console.error("خطأ في رفع الصورة:", error);
                alert("فشل في رفع الصورة");
                return "";
            }
        }

        // دالة إضافة العلامة المائية
        function getWatermarkedUrl(url, type = 'image') {
            if (!url) return url;
            
            if (url.includes("cloudinary.com")) {
                const watermarkTransform = `l_${LOGO_ID},o_40,g_south_east,w_0.3,fl_relative,x_5,y_5,fl_layer_apply`;
                
                if (type === 'video') {
                    return url.replace("/video/upload/", `/video/upload/${watermarkTransform}/`);
                } else {
                    return url.replace("/image/upload/", `/image/upload/${watermarkTransform}/`);
                }
            }
            
            return url;
        }

        // دوال الكاميرا والذكاء الاصطناعي
        function openAICamera() {
            const modal = document.getElementById('aiCameraModal');
            modal.classList.add('active');
            startCamera();
        }
        
        function closeAICamera() {
            const modal = document.getElementById('aiCameraModal');
            modal.classList.remove('active');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            document.getElementById('aiRecommendations').classList.remove('active');
            document.getElementById('aiAnalysisStatus').classList.remove('active');
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('cameraStream').style.display = 'block';
        }
        
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                const video = document.getElementById('cameraStream');
                video.srcObject = cameraStream;
            } catch (err) {
                console.error("خطأ في تشغيل الكاميرا:", err);
                alert("تعذر تشغيل الكاميرا. يرجى التأكد من سماح الموقع باستخدام الكاميرا.");
            }
        }
        
        function captureImage() {
            const video = document.getElementById('cameraStream');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
                await analyzeImageWithGemini(file);
            }, 'image/jpeg');
        }
        
        function uploadImage() {
            document.getElementById('imageUploadInput').click();
        }
        
        async function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                await analyzeImageWithGemini(input.files[0]);
            }
        }
        
        // دوال مساعدة للصورة
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // تحليل الصورة باستخدام Gemini API
        async function analyzeImageWithGemini(file) {
            // إظهار الصورة الملتقطة
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('capturedImage');
                if (img) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                    const video = document.getElementById('cameraStream');
                    if (video) video.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
            
            // إظهار حالة التحليل
            const statusEl = document.getElementById('aiAnalysisStatus');
            const recsEl = document.getElementById('aiRecommendations');
            if (statusEl) statusEl.classList.add('active');
            if (recsEl) recsEl.classList.remove('active');
            
            try {
                // تحويل الصورة إلى Base64
                const base64Image = await fileToBase64(file);
                
                // نموذج Gemini المتاح
                const model = 'gemini-1.5-pro';
                
                const prompt = "أنت خبير ديكور وستائر متخصص. حلل هذه الصورة واقترح لي 3 ألوان للستائر تتناغم مع الغرفة. أجب فقط بالألوان مفصولة بفواصل.";
                
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }]
                };
                
                console.log(`إرسال الطلب إلى Gemini API باستخدام نموذج ${model}...`);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    console.error("خطأ من Gemini API:", data);
                    throw new Error(data.error?.message || "خطأ في الاتصال");
                }
                
                console.log("استجابة Gemini:", data);
                
                let analysis = "";
                if (data.candidates && 
                    data.candidates[0] && 
                    data.candidates[0].content && 
                    data.candidates[0].content.parts && 
                    data.candidates[0].content.parts[0]) {
                    analysis = data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("تنسيق استجابة غير متوقع");
                }
                
                console.log("تحليل Gemini:", analysis);
                
                const colors = extractColorsSimple(analysis);
                
                await findMatchingProductsByColors(colors);
                
            } catch (error) {
                console.error("خطأ في تحليل الصورة:", error);
                
                let errorMessage = "حدث خطأ في تحليل الصورة. ";
                
                if (error.message.includes("API key")) {
                    errorMessage += "مفتاح API غير صالح.";
                } else if (error.message.includes("not found") || error.message.includes("not supported")) {
                    errorMessage += "النموذج غير متاح. سيتم استخدام المحاكاة المحلية.";
                    // استخدم المحاكاة المحلية كبديل
                    await analyzeImageWithFallback(file);
                    return;
                } else {
                    errorMessage += "الرجاء المحاولة مرة أخرى.";
                }
                
                alert(errorMessage);
                
                if (statusEl) statusEl.classList.remove('active');
            }
        }

        // نسخة احتياطية - محاكاة محلية
        async function analyzeImageWithFallback(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('capturedImage');
                if (img) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                    const video = document.getElementById('cameraStream');
                    if (video) video.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
            
            const statusEl = document.getElementById('aiAnalysisStatus');
            const recsEl = document.getElementById('aiRecommendations');
            if (statusEl) statusEl.classList.add('active');
            if (recsEl) recsEl.classList.remove('active');
            
            try {
                // محاكاة تأخير التحليل
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // اقتراح ألوان افتراضية
                const suggestedColors = ['ذهبي', 'بيج', 'بني'];
                
                console.log("ألوان مقترحة (محاكاة):", suggestedColors);
                
                await findMatchingProductsByColors(suggestedColors);
                
            } catch (error) {
                console.error("خطأ في المحاكاة المحلية:", error);
                alert("حدث خطأ. الرجاء المحاولة مرة أخرى.");
                if (statusEl) statusEl.classList.remove('active');
            }
        }

        // دالة مبسطة لاستخراج الألوان
        function extractColorsSimple(text) {
            const colors = [];
            
            // قائمة الألوان الشائعة في متجرك
            const colorKeywords = {
                'ذهبي': ['ذهبي', 'ذهب', 'gold'],
                'بني': ['بني', 'brown'],
                'بيج': ['بيج', 'beige', 'كريم', 'cream'],
                'أبيض': ['أبيض', 'white'],
                'رمادي': ['رمادي', 'gray', 'grey'],
                'أسود': ['أسود', 'black'],
                'أزرق': ['أزرق', 'blue'],
                'أخضر': ['أخضر', 'green'],
                'أحمر': ['أحمر', 'red']
            };
            
            // البحث عن الألوان في النص
            for (const [arColor, keywords] of Object.entries(colorKeywords)) {
                for (const keyword of keywords) {
                    if (text.toLowerCase().includes(keyword.toLowerCase())) {
                        if (!colors.includes(arColor)) {
                            colors.push(arColor);
                        }
                        break;
                    }
                }
            }
            
            // إذا لم يجد ألوان، استخدم ألوان افتراضية
            if (colors.length === 0) {
                return ['ذهبي', 'بيج', 'بني'];
            }
            
            return colors.slice(0, 3);
        }
        
        // البحث عن منتجات حسب الألوان - نسخة محسنة
        async function findMatchingProductsByColors(colors) {
            const products = await getCachedData('products') || {};
            const productsList = Object.values(products);
            
            // التحقق من وجود منتجات
            if (productsList.length === 0) {
                console.log("لا توجد منتجات في قاعدة البيانات");
                
                // عرض رسالة للمستخدم
                const container = document.getElementById('aiRecommendations');
                const statusEl = document.getElementById('aiAnalysisStatus');
                
                if (container && statusEl) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:30px;">
                            <i class="fas fa-palette" style="font-size:4rem; color:var(--gold); margin-bottom:15px;"></i>
                            <h3 style="color:var(--brown); margin-bottom:10px;">الألوان المقترحة:</h3>
                            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px; flex-wrap:wrap;">
                                ${colors.map(color => `
                                    <span style="background:var(--gold); color:white; padding:8px 20px; border-radius:30px; font-weight:700;">${color}</span>
                                `).join('')}
                            </div>
                            <p style="color:#666; font-size:1.1rem;">لا توجد منتجات بعد!</p>
                            <p style="color:#999; margin-top:15px;">سيتم إضافة منتجات قريباً</p>
                            <p style="color:#999; font-size:0.85rem; margin-top:10px;">يمكنك إضافة منتجات من لوحة الإدارة</p>
                        </div>
                    `;
                    statusEl.classList.remove('active');
                    container.classList.add('active');
                }
                return;
            }
            
            // خريطة الألوان
            const colorMap = {
                'ذهبي': ['ذهب', 'gold', 'ذهبية'],
                'بني': ['brown', 'بنية'],
                'بيج': ['beige', 'كريم', 'cream'],
                'أبيض': ['white'],
                'رمادي': ['gray', 'grey']
            };
            
            const searchTerms = [];
            colors.forEach(color => {
                searchTerms.push(color);
                for (const [key, values] of Object.entries(colorMap)) {
                    if (color.includes(key) || values.some(v => color.includes(v))) {
                        searchTerms.push(key);
                        searchTerms.push(...values);
                    }
                }
            });
            
            console.log("كلمات البحث:", searchTerms);
            
            const matches = productsList.filter(p => {
                const nameLower = p.name.toLowerCase();
                const catLower = p.category.toLowerCase();
                
                return searchTerms.some(term => 
                    nameLower.includes(term.toLowerCase()) || catLower.includes(term.toLowerCase())
                );
            }).slice(0, 6);
            
            displayRecommendations(matches, colors);
        }
        
        // تعديل دالة عرض التوصيات
        function displayRecommendations(matches, suggestedColors = []) {
            const container = document.getElementById('aiRecommendations');
            const statusEl = document.getElementById('aiAnalysisStatus');
            
            if (container && statusEl) {
                if (matches.length === 0) {
                    // إذا لم يجد منتجات مطابقة
                    container.innerHTML = `
                        <div style="text-align:center; padding:20px;">
                            <i class="fas fa-palette" style="font-size:3rem; color:var(--gold); margin-bottom:10px;"></i>
                            <p style="color:var(--brown); font-weight:700; margin-bottom:10px;">الألوان المقترحة:</p>
                            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px; flex-wrap:wrap;">
                                ${suggestedColors.map(color => `
                                    <span style="background:var(--gold); color:white; padding:5px 15px; border-radius:20px;">${color}</span>
                                `).join('')}
                            </div>
                            <p style="color:#666;">لا توجد منتجات بهذه الألوان حالياً</p>
                            <p style="color:#999; font-size:0.85rem; margin-top:10px;">يمكنك إضافة منتجات من لوحة الإدارة</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = matches.map(p => `
                        <div class="ai-recommendation-card" onclick='openCalc(${JSON.stringify(p).replace(/'/g, "&apos;")}); closeAICamera()'>
                            <img src="${getWatermarkedUrl(p.img || (p.images && p.images[0]), 'image')}" loading="lazy">
                            <div class="info">
                                <h4>${p.name}</h4>
                                <div class="price">${parseInt(p.price).toLocaleString()} د.ع</div>
                                <div class="match-badge">✔ مناسب</div>
                            </div>
                        </div>
                    `).join('');
                }
                
                statusEl.classList.remove('active');
                container.classList.add('active');
            }
        }

        // البحث الذكي مع الاقتراحات
        async function handleSmartSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const suggestions = document.getElementById('searchSuggestions');
            
            if (query.length < 2) { 
                suggestions.style.display = 'none';
                return; 
            }

            const products = await getCachedData('products') || {};
            
            const results = Object.values(products).filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.category.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (results.length > 0) {
                suggestions.innerHTML = results.map(p => `
                    <div onclick='openCalc(${JSON.stringify(p).replace(/'/g, "&apos;")}); suggestions.style.display="none"; document.getElementById("searchInput").value=""'>
                        <img src="${getWatermarkedUrl(p.img || (p.images && p.images[0]), 'image')}" loading="lazy">
                        <span>${p.name}</span>
                        <small>${p.category}</small>
                    </div>
                `).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        // عرض التوصيات
        async function getRecommendations(currentProduct) {
            const products = await getCachedData('products') || {};
            const productsList = Object.values(products);
            
            const sameCategory = productsList.filter(p => 
                p.category === currentProduct.category && 
                p.name !== currentProduct.name
            ).slice(0, 4);
            
            const container = document.getElementById('recommendations');
            if (sameCategory.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = `
                <h3>قد يعجبك أيضاً</h3>
                <div class="recommendations-grid">
                    ${sameCategory.map(p => `
                        <div onclick='openCalc(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                            <img src="${getWatermarkedUrl(p.img || (p.images && p.images[0]), 'image')}" loading="lazy">
                            <h4>${p.name}</h4>
                            <p>${parseInt(p.price).toLocaleString()} د.ع</p>
                        </div>
                    `).join('')}
                </div>
            `;
            container.style.display = 'block';
        }

        async function publishCat() {
            const file = document.getElementById('admCatFile').files[0];
            const name = getValue('admCatName');
            
            if(!file || !name) {
                alert("أكمل بيانات القسم");
                return;
            }
            
            const url = await uploadImage(file);
            if (url) {
                db.ref('categories').push({name: name, img: url}).then(() => {
                    alert("تم إضافة القسم بنجاح");
                    document.getElementById('admCatName').value = "";
                    document.getElementById('admCatFile').value = "";
                    cache.categories = null;
                });
            }
        }

        function addVideoInput() {
            const container = document.getElementById('videoInputsContainer');
            const newIndex = container.children.length + 1;
            
            const div = document.createElement('div');
            div.className = 'video-input-group';
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            
            div.innerHTML = `
                <input type="url" class="admProdVideo" placeholder="رابط فيديو ${newIndex}" style="flex: 1;">
                <button type="button" onclick="removeVideoInput(this)" style="background: var(--red); color: white; border: none; width: 40px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            
            container.appendChild(div);
        }

        function removeVideoInput(button) {
            if (document.querySelectorAll('.video-input-group').length > 1) {
                button.closest('.video-input-group').remove();
            } else {
                alert("يجب أن يبقى حقل فيديو واحد على الأقل");
            }
        }

        async function publishProd() {
            const files = document.getElementById('admProdImages').files;
            const cat = document.getElementById('admProdCatSelect').value;
            const name = getValue('admProdName');
            const price = getValue('admProdPrice');
            
            const videoInputs = document.querySelectorAll('.admProdVideo');
            const videos = [];
            videoInputs.forEach(input => {
                if (input.value.trim()) {
                    videos.push(input.value.trim());
                }
            });
            
            if(files.length === 0 || !name || !price || cat === "اختر قسم المنتجات") {
                alert("أكمل بيانات المنتج (صورة واحدة على الأقل)");
                return;
            }
            
            const imageUrls = [];
            for (let i = 0; i < files.length; i++) {
                const url = await uploadImage(files[i]);
                if (url) {
                    imageUrls.push(url);
                }
            }
            
            if (imageUrls.length > 0) {
                db.ref('products').push({ 
                    category: cat, 
                    name: name, 
                    price: parseInt(price), 
                    images: imageUrls,
                    videos: videos,
                    img: imageUrls[0]
                }).then(() => {
                    alert("✅ تم نشر المنتج بنجاح!\n" + 
                          "🖼️ صور: " + imageUrls.length + "\n" +
                          "🎥 فيديوهات: " + videos.length + "\n" +
                          (videos.some(v => v.includes('cloudinary.com')) ? 
                           "🛡️ فيديوهات Cloudinary محمية بعلامة مائية" : 
                           "📌 روابط يوتيوب ستعمل بدون علامة مائية"));
                    
                    document.getElementById('admProdName').value = "";
                    document.getElementById('admProdPrice').value = "";
                    document.getElementById('admProdImages').value = "";
                    
                    document.getElementById('videoInputsContainer').innerHTML = `
                        <div class="video-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="url" class="admProdVideo" placeholder="رابط فيديو 1">
                            <button type="button" onclick="addVideoInput()" style="background: var(--gold); color: white; border: none; width: 40px; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;
                    
                    cache.products = null;
                });
            }
        }

        async function publishPayment() {
            const file = document.getElementById('admPayFile').files[0];
            const name = getValue('admPayName');
            
            if(!file || !name) {
                alert("أكمل بيانات طريقة الدفع");
                return;
            }
            
            const url = await uploadImage(file);
            if (url) {
                db.ref('payments').push({ 
                    name: name, 
                    img: url 
                }).then(() => {
                    alert("تم إضافة طريقة الدفع بنجاح");
                    document.getElementById('admPayName').value = "";
                    document.getElementById('admPayFile').value = "";
                    cache.payments = null;
                });
            }
        }

        function deleteItem(ref, key) { 
            if(confirm("هل تريد الحذف نهائياً؟")) {
                db.ref(ref).child(key).remove().then(() => {
                    if (ref === 'categories') cache.categories = null;
                    if (ref === 'products') cache.products = null;
                    if (ref === 'payments') cache.payments = null;
                });
            }
        }

        function openCat(categoryName) { 
            localStorage.setItem('lastCat', categoryName);
            getCachedData('products').then(products => {
                const items = Object.values(products || {}).filter(i => i.category === categoryName); 
                document.getElementById('catTitle').innerText = categoryName; 
                
                if (items.length === 0) {
                    document.getElementById('catGrid').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;">لا توجد منتجات في هذا القسم</div>';
                } else {
                    document.getElementById('catGrid').innerHTML = items.map(x => `
                        <div class="cat-card-new" onclick='openCalc(${JSON.stringify(x).replace(/'/g, "&apos;")})'>
                            <img src="${getWatermarkedUrl(x.img || (x.images && x.images[0]), 'image')}" loading="lazy">
                            <div style="padding:20px;text-align:center;"><h3>${x.name}</h3><p style="color:var(--gold);font-weight:900;">${parseInt(x.price).toLocaleString()} د.ع</p></div>
                        </div>`).join('');
                }
                showPage('categoryView'); 
            }); 
        }

        function openCalc(product) { 
            currentProduct = product; 
            localStorage.setItem('lastProd', JSON.stringify(product));

            const mediaItems = [];

            getRecommendations(product);

            if (product.videos && Array.isArray(product.videos)) {
                product.videos.forEach(video => {
                    if (video) {
                        mediaItems.push({ type: 'video', url: getWatermarkedUrl(video, 'video') });
                    }
                });
            }

            if (product.images && Array.isArray(product.images)) {
                product.images.forEach(img => {
                    mediaItems.push({ type: 'image', url: getWatermarkedUrl(img, 'image') });
                });
            } else if (product.img) {
                mediaItems.push({ type: 'image', url: getWatermarkedUrl(product.img, 'image') });
            }

            openAlibabaViewer({ ...product, mediaItems: mediaItems });

            document.getElementById('pName').innerText = product.name;
            document.getElementById('pPrice').innerText = parseInt(product.price).toLocaleString();
            document.getElementById('pImg').src = getWatermarkedUrl(product.img || (product.images && product.images[0]), 'image');
            document.getElementById('hIn').value = '';
            
            showPage('productCalculator');
        }

        function addToCart() {
            const h = parseFloat(document.getElementById('hIn').value);
            if(!h || h <= 0) return alert("أدخل الطول بالمتر");
            if(!currentProduct) return alert("حدث خطأ");
            
            cart.push({ 
                n: currentProduct.name, 
                p: Math.round(h * currentProduct.price), 
                img: getWatermarkedUrl(currentProduct.img || (currentProduct.images && currentProduct.images[0]), 'image'),
                length: h
            });
            
            document.getElementById('globalCartCount').innerText = cart.length; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            alert("تمت الإضافة للسلة!");
            document.getElementById('hIn').value = '';
        }

        function toggleCartModal() {
            const overlay = document.getElementById('cartOverlay');
            overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
            
            if (overlay.style.display === 'flex') {
                let total = 0;
                let html = '';
                
                cart.forEach((item, idx) => {
                    total += item.p;
                    html += `<div class="cart-item" style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #eee;">
                        <img src="${item.img}" loading="lazy" style="width:50px;height:50px;border-radius:8px;object-fit:cover;">
                        <div style="flex:1;"><b>${item.n}</b><br><span style="color:var(--gold)">${item.p.toLocaleString()} د.ع</span></div>
                        <i class="fas fa-trash" style="color:red;cursor:pointer;" onclick="removeFromCart(${idx})"></i>
                    </div>`;
                });
                
                if (cart.length > 0) {
                    html += `<div style="margin-top:15px;font-weight:900;text-align:center;background:#eee;padding:10px;">الإجمالي: ${total.toLocaleString()} د.ع</div>`;
                } else {
                    html = '<p style="text-align:center;padding:20px;">السلة فارغة</p>';
                }
                
                document.getElementById('cartItemsList').innerHTML = html;
            }
        }

        function removeFromCart(index) { 
            cart.splice(index, 1); 
            document.getElementById('globalCartCount').innerText = cart.length; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            toggleCartModal(); 
        }

        function sendOrder() {
            if(cart.length === 0) return alert("السلة فارغة");
            
            const city = document.getElementById('userCity').value;
            const payment = document.getElementById('userPayment').value;
            const install = document.getElementById('userInstall').value;

            let msg = `*طلب شراء جديد من شبابيك للستائر* 🪟\n\n`;
            msg += `📍 *المحافظة:* ${city}\n`;
            msg += `🛠 *خدمة التركيب:* ${install}\n`;
            msg += `💳 *طريقة الدفع:* ${payment}\n`;
            msg += `------------------------------\n\n`;
            
            let total = 0;

            cart.forEach((item, index) => {
                msg += `*${index + 1}- الموديل:* ${item.n}\n`;
                msg += `💰 *السعر:* ${item.p.toLocaleString()} د.ع\n`;
                msg += `🖼 *صورة الموديل:* ${item.img}\n`;
                msg += `------------------------------\n`;
                total += item.p;
            });
            
            msg += `\n💰 *الإجمالي الكلي للطلب:* ${total.toLocaleString()} د.ع\n\n`;
            msg += `_شكراً لاختياركم شبابيك - ظل وذوق_`;

            const waNumber = "9647883002797";
            const waUrl = `https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`;
            
            window.open(waUrl, '_blank');

            cart = []; 
            document.getElementById('globalCartCount').innerText = "0"; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            toggleCartModal();
        }

        const heroVideo = document.querySelector('.hero-video');
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                heroVideo.pause();
            } else {
                heroVideo.play().catch(() => {});
            }
        });

        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            const suggestions = document.getElementById('searchSuggestions');
            if (searchContainer && !searchContainer.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.page) {
                showPage(event.state.page, false); 
            } else {
                showPage('homePage', false);
            }
        });

        window.addEventListener('load', () => {
            getCachedData('categories').then(cats => {
                const list = document.getElementById('categoriesList');
                if(list) {
                    if (!cats || Object.keys(cats).length === 0) {
                        list.innerHTML = '<div style="grid-column:1/-1; text-align:center;">لا توجد أقسام</div>';
                    } else {
                        list.innerHTML = Object.values(cats).map(c => 
                            `<div class="cat-card-new" onclick="openCat('${c.name}')">
                                <img src="${c.img}" loading="lazy">
                                <div style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:var(--gold);color:white;padding:10px 25px;border-radius:12px;font-weight:900;">${c.name}</div>
                            </div>`
                        ).join('');
                    }
                }
                
                const admListCats = document.getElementById('admListCats');
                if(admListCats) {
                    admListCats.innerHTML = Object.entries(cats || {}).map(([k,v]) => 
                        `<tr><td>${v.name}</td><td><button onclick="deleteItem('categories','${k}')" style="color:red;border:none;background:none;cursor:pointer;">حذف</button></td></tr>`
                    ).join('');
                }
                
                const admProdCatSelect = document.getElementById('admProdCatSelect');
                if(admProdCatSelect) {
                    admProdCatSelect.innerHTML = '<option disabled selected>اختر قسم المنتجات</option>' + 
                        Object.values(cats || {}).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                }
            });

            getCachedData('products').then(data => {
                const list = document.getElementById('admListProds');
                if(list) {
                    list.innerHTML = Object.entries(data || {}).map(([k,v]) => 
                        `<tr><td>${v.name}</td><td><button onclick="deleteItem('products','${k}')" style="color:red;border:none;background:none;cursor:pointer;">حذف</button></td></tr>`
                    ).join('');
                }
            });

            getCachedData('payments').then(data => {
                const userList = document.getElementById('paymentList');
                const selectBox = document.getElementById('userPayment');

                if(selectBox) {
                    selectBox.innerHTML = Object.values(data || {}).map(pay => 
                        `<option value="${pay.name}">${pay.name}</option>`
                    ).join('') || '<option value="نقد عند الاستلام">نقد عند الاستلام</option>';
                }

                if(userList) {
                    if (!data || Object.keys(data).length === 0) {
                        userList.innerHTML = '<div style="grid-column:1/-1; text-align:center;">لا توجد طرق دفع</div>';
                    } else {
                        userList.innerHTML = Object.values(data).map(pay => `
                            <div class="payment-card">
                                <img src="${pay.img}" loading="lazy">
                                <div class="payment-overlay">${pay.name}</div>
                            </div>
                        `).join('');
                    }
                }
                
                const admListPays = document.getElementById('admListPays');
                if(admListPays) {
                    admListPays.innerHTML = Object.entries(data || {}).map(([k,v]) => 
                        `<tr><td>${v.name}</td><td><button onclick="deleteItem('payments','${k}')" style="color:red;border:none;background:none;cursor:pointer;">حذف</button></td></tr>`
                    ).join('');
                }
            });

            const hash = location.hash.replace('#', '');
            if (hash === 'categoryView') {
                const lastCat = localStorage.getItem('lastCat');
                if(lastCat) openCat(lastCat);
            } else if (hash === 'productCalculator') {
                const lastProd = localStorage.getItem('lastProd');
                if(lastProd) openCalc(JSON.parse(lastProd));
            } else {
                showPage(hash || 'homePage', false);
            }

            document.getElementById('globalCartCount').innerText = cart.length;
            setupAlibabaViewerEvents();
        });

        // ===== نظام المستعرض =====
        let alibabaViewerData = {
            isOpen: false,
            currentIndex: 0,
            mediaItems: [],
            product: null,
            isAutoPlaying: false,
            autoPlayInterval: null,
            startX: 0,
            isDragging: false
        };

        function extractYoutubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/shorts\/)([^&\n?#]+)/,
                /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,
                /youtube.com\/shorts\/([a-zA-Z0-9_-]+)/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1] && match[1].length === 11) {
                    return match[1];
                }
                if (match && match[7] && match[7].length === 11) {
                    return match[7];
                }
            }
            
            return null;
        }

        function addNavigationButtons(container) {
            const prevButton = document.createElement('button');
            prevButton.className = 'alibaba-slide-nav prev';
            prevButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            prevButton.onclick = () => changeAlibabaSlide(alibabaViewerData.currentIndex - 1);
            
            const nextButton = document.createElement('button');
            nextButton.className = 'alibaba-slide-nav next';
            nextButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            nextButton.onclick = () => changeAlibabaSlide(alibabaViewerData.currentIndex + 1);
            
            container.appendChild(prevButton);
            container.appendChild(nextButton);
        }

        function openAlibabaViewer(product) {
            alibabaViewerData.product = product;
            alibabaViewerData.currentIndex = 0;
            alibabaViewerData.isOpen = true;
            
            alibabaViewerData.mediaItems = product.mediaItems || [];
            
            const viewer = document.getElementById('alibabaViewer');
            
            document.getElementById('alibabaProductName').textContent = product.name;
            document.getElementById('alibabaProductTitle').textContent = product.name;
            document.getElementById('alibabaProductPrice').textContent = parseInt(product.price).toLocaleString();
            document.getElementById('alibabaProductCode').textContent = `موديل: ST-${Math.floor(Math.random() * 10000)}`;
            document.getElementById('alibabaProductRating').textContent = `4.8 (${Math.floor(Math.random() * 200) + 50} تقييم)`;
            document.getElementById('alibabaProductSold').textContent = `أكثر من ${Math.floor(Math.random() * 500) + 200} قطعة مباعة`;
            
            const container = document.getElementById('alibabaMainImageContainer');
            container.innerHTML = '';
            
            const firstItem = alibabaViewerData.mediaItems[0];
            if (firstItem) {
                if (firstItem.type === 'video') {
                    const videoId = extractYoutubeId(firstItem.url);
                    if (videoId) {
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=1&rel=0`;
                        iframe.allow = "autoplay; encrypted-media";
                        iframe.allowFullscreen = true;
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        container.appendChild(iframe);
                        
                        stopAlibabaAutoPlay();
                        
                        setTimeout(() => {
                            startAlibabaAutoPlay();
                        }, 30000);
                    } else {
                        const video = document.createElement('video');
                        video.src = firstItem.url;
                        video.controls = true;
                        video.autoplay = true;
                        video.muted = true;
                        video.loop = false;
                        video.style.width = '100%';
                        video.style.height = '100%';
                        video.style.objectFit = 'contain';
                        
                        video.addEventListener('ended', () => {
                            startAlibabaAutoPlay();
                        });
                        
                        container.appendChild(video);
                        
                        stopAlibabaAutoPlay();
                    }
                } else {
                    const img = document.createElement('img');
                    img.src = firstItem.url;
                    img.className = 'alibaba-main-image';
                    img.alt = '';
                    container.appendChild(img);
                    
                    startAlibabaAutoPlay();
                }
            }
            
            addNavigationButtons(container);
            updateThumbnailGallery();
            calculateAlibabaTotal();
            
            viewer.classList.add('active');
        }

        function updateThumbnailGallery() {
            const gallery = document.getElementById('alibabaThumbnailGallery');
            gallery.innerHTML = alibabaViewerData.mediaItems.map((item, index) => `
                <div class="alibaba-thumbnail ${item.type === 'video' ? 'video-thumb' : ''} ${index === alibabaViewerData.currentIndex ? 'active' : ''}" 
                     onclick="changeAlibabaSlide(${index})">
                    ${item.type === 'video' 
                        ? `<video src="${item.url}" muted></video>` 
                        : `<img src="${item.url}" loading="lazy">`
                    }
                </div>
            `).join('');
        }

        function closeAlibabaViewer() {
            document.getElementById('alibabaViewer').classList.remove('active');
            alibabaViewerData.isOpen = false;
            stopAlibabaAutoPlay();
        }

        function changeAlibabaSlide(index) {
            if (index < 0) index = alibabaViewerData.mediaItems.length - 1;
            if (index >= alibabaViewerData.mediaItems.length) index = 0;
            
            alibabaViewerData.currentIndex = index;
            
            const container = document.getElementById('alibabaMainImageContainer');
            const item = alibabaViewerData.mediaItems[index];
            
            container.innerHTML = '';
            
            if (item.type === 'video') {
                const videoId = extractYoutubeId(item.url);
                if (videoId) {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=1&rel=0`;
                    iframe.allow = "autoplay; encrypted-media";
                    iframe.allowFullscreen = true;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    container.appendChild(iframe);
                    
                    stopAlibabaAutoPlay();
                    
                    setTimeout(() => {
                        startAlibabaAutoPlay();
                    }, 30000);
                } else {
                    const video = document.createElement('video');
                    video.src = item.url;
                    video.controls = true;
                    video.autoplay = true;
                    video.muted = true;
                    video.loop = false;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'contain';
                    
                    video.addEventListener('ended', () => {
                        startAlibabaAutoPlay();
                    });
                    
                    container.appendChild(video);
                    
                    stopAlibabaAutoPlay();
                }
            } else {
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'alibaba-main-image';
                img.alt = '';
                container.appendChild(img);
            }
            
            addNavigationButtons(container);
            updateThumbnailGallery();
        }

        function calculateAlibabaTotal() {
            const meters = parseFloat(document.getElementById('alibabaMetersInput').value) || 1;
            const price = alibabaViewerData.product ? alibabaViewerData.product.price : 0;
            const total = meters * price;
            document.getElementById('alibabaTotalPrice').textContent = total.toLocaleString() + ' د.ع';
        }

        function addFromAlibabaViewer() {
            if (!alibabaViewerData.product) return;
            
            const meters = parseFloat(document.getElementById('alibabaMetersInput').value);
            if (!meters || meters <= 0) {
                alert("الرجاء إدخال عدد الأمتار");
                return;
            }
            
            const totalPrice = meters * alibabaViewerData.product.price;
            
            cart.push({ 
                n: alibabaViewerData.product.name, 
                p: Math.round(totalPrice), 
                img: getWatermarkedUrl(alibabaViewerData.product.img || (alibabaViewerData.product.images && alibabaViewerData.product.images[0]), 'image'),
                length: meters
            });
            
            document.getElementById('globalCartCount').innerText = cart.length; 
            localStorage.setItem('shababek_cart', JSON.stringify(cart));
            alert("تمت الإضافة للسلة!");
        }

        function checkoutFromAlibabaViewer() {
            closeAlibabaViewer();
            toggleCartModal();
        }

        function startAlibabaAutoPlay() {
            if (alibabaViewerData.mediaItems.length <= 1) return;
            if (alibabaViewerData.isAutoPlaying) return;
            
            alibabaViewerData.isAutoPlaying = true;
            alibabaViewerData.autoPlayInterval = setInterval(() => {
                let nextIndex = alibabaViewerData.currentIndex + 1;
                if (nextIndex >= alibabaViewerData.mediaItems.length) {
                    nextIndex = 0;
                }
                changeAlibabaSlide(nextIndex);
            }, 3000);
        }

        function stopAlibabaAutoPlay() {
            alibabaViewerData.isAutoPlaying = false;
            if (alibabaViewerData.autoPlayInterval) {
                clearInterval(alibabaViewerData.autoPlayInterval);
                alibabaViewerData.autoPlayInterval = null;
            }
        }

        function setupAlibabaViewerEvents() {
            document.getElementById('alibabaMetersInput').addEventListener('input', calculateAlibabaTotal);
            
            const container = document.getElementById('alibabaMainImageContainer');
            container.addEventListener('touchstart', (e) => {
                alibabaViewerData.startX = e.touches[0].clientX;
                alibabaViewerData.isDragging = true;
            });
            
            container.addEventListener('touchmove', (e) => {
                if (!alibabaViewerData.isDragging) return;
                e.preventDefault();
                
                const currentX = e.touches[0].clientX;
                const diff = alibabaViewerData.startX - currentX;
                
                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        changeAlibabaSlide(alibabaViewerData.currentIndex + 1);
                    } else {
                        changeAlibabaSlide(alibabaViewerData.currentIndex - 1);
                    }
                    alibabaViewerData.isDragging = false;
                }
            });
            
            container.addEventListener('touchend', () => {
                alibabaViewerData.isDragging = false;
            });
        }
    </script>
</body>
</html>