<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const workerUrl = "https://0.bilalmohammedsalem23.workers.dev/";

async function analyzeRoom(input){
  if(!input.files || !input.files[0]) return;
  const file = input.files[0];
  const reader = new FileReader();
  const box = document.getElementById("aiResponse");
  const avatar = document.getElementById("drAvatar");

  // تأثير بصري أثناء المعالجة
  avatar.style.filter = "grayscale(100%) blur(2px)";
  avatar.src="https://i.ibb.co/ZzMvg7Mz/Disgust-removebg-preview.png";
  box.innerHTML='<i class="fas fa-robot fa-bounce"></i> <b>ذكاء شبابيك الاصطناعي يفحص غرفتك الآن...</b>';

  reader.onload = async (e)=>{
    // تحويل وتحجيم الصورة لسرعة الاستجابة
    const img = new Image();
    img.src = e.target.result;
    img.onload = async () => {
        const canvas = document.createElement('canvas');
        canvas.width = 600; 
        canvas.height = img.height * (600 / img.width);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(",")[1];

        try{
          const response = await fetch(workerUrl,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({image:base64Data})
          });
          const data = await response.json();
          
          avatar.style.filter = "none";
          avatar.src="https://i.ibb.co/q3z1RscN/Neutral-removebg-preview.png";
          
          // عرض النتيجة مع تأثير احتفالي
          box.innerHTML = `<b>نصيحة دكتور ديكور:</b><br>${data.reply || "عذراً، لم أتمكن من تحليل الصورة."}`;
          confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

          // إضافة زر انتقال سريع للمنتجات
          box.innerHTML += `<br><button onclick="location.href='index.html?go=categories'" style="margin-top:15px; background:var(--brown); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:0.9rem;">تصفح الموديلات المقترحة</button>`;

        }catch(err){
          avatar.style.filter = "none";
          avatar.src="https://i.ibb.co/q3z1RscN/Neutral-removebg-preview.png";
          box.innerHTML="عذراً، فشل الاتصال بالـ Worker. تأكد من إعدادات الـ CORS في Cloudflare.";
        }
    };
  };
  reader.readAsDataURL(file);
}
</script>
