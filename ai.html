<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دكتور ديكور | شبابيك للستائر</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --gold: #d9b382; --dark: #2c2420; --light: #fdfaf7; --white: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--light); color: var(--dark); }

        /* الهيدر الاحترافي */
        header { background: var(--white); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .brand { font-weight: 900; font-size: 1.4rem; color: var(--dark); text-decoration: none; }
        .brand span { color: var(--gold); }

        /* منطقة الدكتور */
        .ai-container { max-width: 600px; margin: 40px auto; padding: 20px; text-align: center; }
        .dr-card { background: var(--white); padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); position: relative; }
        
        .avatar-box { width: 140px; height: 140px; margin: -70px auto 20px; border-radius: 50%; border: 5px solid var(--white); background: var(--gold); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        .bubble { background: #f8f9fa; padding: 20px; border-radius: 15px; border-right: 5px solid var(--gold); margin: 20px 0; min-height: 80px; font-weight: 600; line-height: 1.8; text-align: right; }

        /* أزرار التحكم */
        .upload-btn { background: var(--gold); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 900; cursor: pointer; transition: 0.3s; width: 100%; }
        .upload-btn:hover { background: var(--dark); transform: scale(1.02); }
        .upload-btn i { margin-left: 10px; }

        .loading-spinner { display: none; margin: 10px auto; color: var(--gold); font-size: 2rem; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="brand">شبابيك <span>للستائر</span></a>
    <i class="fas fa-bars" style="font-size: 1.5rem; color: var(--gold);"></i>
</header>

<div class="ai-container">
    <div class="dr-card">
        <div class="avatar-box">
            <img id="drImg" src="https://i.ibb.co/q3z1RscN/Neutral-removebg-preview.png" alt="Doctor Decor">
        </div>
        
        <h3>استشارة الدكتور الذكي</h3>
        <div class="bubble" id="responseArea">
            أهلاً بيك عيني! أنا دكتور ديكور من شبابيك. بس صورلي غرفتك واترك الباقي عليّ، راح أنصحك بأفضل ستارة تناسب ذوقك.
        </div>

        <div id="loader" class="loading-spinner"><i class="fas fa-circle-notch fa-spin"></i></div>

        <input type="file" id="fileInput" accept="image/*" capture="environment" hidden>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-camera"></i> التقط صورة للغرفة
        </button>
    </div>
</div>

<script>
    const WORKER_URL = "https://0.bilalmohammedsalem23.workers.dev/";

    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const resArea = document.getElementById('responseArea');
        const loader = document.getElementById('loader');
        const drImg = document.getElementById('drImg');

        // تجهيز الواجهة للتحميل
        resArea.style.opacity = "0.5";
        resArea.innerText = "جاري تحليل الألوان والديكور...";
        loader.style.display = "block";
        drImg.style.filter = "grayscale(100%)";

        const reader = new FileReader();
        reader.onload = async (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = async () => {
                // معالجة الصورة لضمان أفضل دقة لمزود الخدمة
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1024;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * (MAX_WIDTH / img.width);
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const base64Image = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                try {
                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64Image })
                    });

                    const data = await response.json();
                    
                    // عرض النتيجة
                    resArea.style.opacity = "1";
                    resArea.innerText = data.reply;
                    loader.style.display = "none";
                    drImg.style.filter = "none";

                    // احتفال عند النجاح
                    if(!data.reply.includes("خطأ")) {
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    }

                } catch (error) {
                    resArea.innerText = "عذراً عيني، صار خلل بالاتصال. جرب مرة ثانية.";
                    loader.style.display = "none";
                    drImg.style.filter = "none";
                }
            };
        };
        reader.readAsDataURL(file);
    });
</script>

</body>
</html>
